#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
=========================================================================
01_main_priority.py - POSSIM Customer Priority Maker ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
=========================================================================

ã€ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å½¹å‰²ã€‘
VHC1ï½HCU12æœŸã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã€
å–¶æ¥­å„ªå…ˆåº¦ä»˜ãé¡§å®¢ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

ã€å‡¦ç†ã®æµã‚Œã€‘
1. VHC1ï½5, HCU7ï½12ã®11æœŸåˆ†ã‚’èª­ã¿è¾¼ã¿
2. VHC6æœŸãƒ‡ãƒ¼ã‚¿ã‚’å·®åˆ†è¨ˆç®—ã§å–å¾—
3. å…¨12æœŸã‚’çµ±åˆ
4. æ°åæ­£è¦åŒ–
5. é‡è¤‡å‰Šé™¤ï¼ˆæœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰
6. éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
7. éƒ½é“åºœçœŒã‚’æŠ½å‡º
8. åœ°åŸŸåˆ¥é›†è¨ˆ
9. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
10. å„ªå…ˆé †ä½ã‚’ä»˜ä¸
11. é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®æ•´å½¢
12. Excelå‡ºåŠ›ï¼ˆ4ã‚·ãƒ¼ãƒˆï¼‰

ã€å®Ÿè¡Œæ–¹æ³•ã€‘
python 01_main_priority.py

ã€ä½œæˆè€…ã€‘
Claude Code

ã€æœ€çµ‚æ›´æ–°æ—¥ã€‘
2025-11-05
=========================================================================
"""

import pandas as pd
import sys
from datetime import datetime
from pathlib import Path
import importlib.util

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# Pythonã§ã¯æ•°å­—ã§å§‹ã¾ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã¯ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ããªã„ãŸã‚ã€
# importlibã‚’ä½¿ã£ã¦å‹•çš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™

# 02_config.py ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
config_spec = importlib.util.spec_from_file_location("config_02", Path(__file__).parent / "02_config.py")
config_module = importlib.util.module_from_spec(config_spec)
sys.modules["config_02"] = config_module
config_spec.loader.exec_module(config_module)

# 03_data_utils.py ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
utils_spec = importlib.util.spec_from_file_location("data_utils_03", Path(__file__).parent / "03_data_utils.py")
utils_module = importlib.util.module_from_spec(utils_spec)
sys.modules["data_utils_03"] = utils_module
utils_spec.loader.exec_module(utils_module)

# ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå†…å®¹ã‚’ç¾åœ¨ã®åå‰ç©ºé–“ã«å±•é–‹
# config ã‹ã‚‰ã™ã¹ã¦ã®å®šæ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from config_02 import *
# data_utils ã‹ã‚‰ã™ã¹ã¦ã®é–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from data_utils_03 import *

# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—1ã€‘å„æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆVHC1ï½5, HCU7ï½12ã®11æœŸåˆ†ï¼‰
# =========================================================================

def load_all_periods():
    """
    VHC1ï½5æœŸã¨HCU7ï½12æœŸã®11æœŸåˆ†ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. å„æœŸã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ãšã¤é–‹ã
    2. ã€Œå—è¬›æœŸã€ã®åˆ—ã‚’è¿½åŠ ï¼ˆä¾‹: VHC1, HCU12ï¼‰
    3. ã€ŒæœŸ_ç•ªå·ã€ã®åˆ—ã‚’è¿½åŠ ï¼ˆä¾‹: 1, 12ï¼‰
    4. ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã®ãƒªã‚¹ãƒˆã«ã¾ã¨ã‚ã‚‹

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    å¾Œã§ã€Œæœ€å¾Œã«å—è¬›ã—ãŸæœŸã€ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã€æœŸç•ªå·ãŒå¿…è¦ã§ã™ã€‚
    ä¾‹: 1äººãŒVHC3ã¨HCU10ã‚’å—è¬›ã—ã¦ã„ã‚‹å ´åˆã€HCU10ï¼ˆ10ï¼‰ãŒæœ€å¾Œã®æœŸ

    æˆ»ã‚Šå€¤:
        pd.DataFrame: 11æœŸåˆ†ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆVHC6ã‚’é™¤ãï¼‰
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—1ã€‘å„æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    print("="*70)

    all_data = []  # ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ç®±

    # å„æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ãšã¤èª­ã¿è¾¼ã‚€
    # HUBSPOT_CSV_FILES ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¾æ›¸
    for period, filepath in HUBSPOT_CSV_FILES.items():
        try:
            # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            # encoding=CSV_ENCODING ã¯ 02_config.py ã§å®šç¾©ï¼ˆutf-8-sigï¼‰
            df = pd.read_csv(filepath, encoding=CSV_ENCODING)

            # å—è¬›æœŸã‚’è¿½åŠ ï¼ˆä¾‹: VHC1ï¼‰
            df['å—è¬›æœŸ'] = period

            # æœŸç•ªå·ã‚’è¿½åŠ ï¼ˆä¾‹: 1ï¼‰
            # PERIOD_MAPPING ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¾æ›¸
            df['æœŸ_ç•ªå·'] = PERIOD_MAPPING[period]

            # ãƒªã‚¹ãƒˆã«è¿½åŠ 
            all_data.append(df)

            print(f"  âœ… {period}: {len(df):,} ä»¶")

        except FileNotFoundError:
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
            print(f"  âŒ {period}: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - {filepath}")
            sys.exit(1)

    # ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹
    # ignore_index=True ã§è¡Œç•ªå·ã‚’æŒ¯ã‚Šç›´ã™
    df_non_vhc6 = pd.concat(all_data, ignore_index=True)

    print(f"\n  ğŸ“Š 11æœŸåˆ†ã®ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: {len(df_non_vhc6):,} ä»¶")

    return df_non_vhc6


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—2ã€‘VHC6æœŸãƒ‡ãƒ¼ã‚¿ã‚’å·®åˆ†è¨ˆç®—ã§å–å¾—
# =========================================================================

def calculate_vhc6_data(df_non_vhc6):
    """
    VHC6æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’å·®åˆ†è¨ˆç®—ã§å–å¾—ã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. å…¨ä½“ãƒ‡ãƒ¼ã‚¿ï¼ˆVHC1ï½HCU12ã®å…¨æœŸï¼‰ã‚’èª­ã¿è¾¼ã‚€
    2. 11æœŸåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
    3. å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
    4. å·®åˆ†è¨ˆç®—: å…¨ä½“ - 11æœŸåˆ† = VHC6æœŸ

    ã€è¨ˆç®—å¼ã€‘
    å…¨ä½“ãƒ‡ãƒ¼ã‚¿ - (VHC1ï½5 + HCU7ï½12) = VHC6æœŸãƒ‡ãƒ¼ã‚¿

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    VHC6æœŸã®å°‚ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸æ­£ç¢ºãªå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
    æ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ã‚’å¾—ã‚‹ãŸã‚ã«å·®åˆ†è¨ˆç®—ã‚’ä½¿ã„ã¾ã™ã€‚

    å¼•æ•°:
        df_non_vhc6 (pd.DataFrame): VHC6ã‚’é™¤ã11æœŸåˆ†ã®ãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        tuple: (VHC6æœŸã®ãƒ‡ãƒ¼ã‚¿, å…¨ä½“ãƒ‡ãƒ¼ã‚¿)
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—2ã€‘VHC6æœŸãƒ‡ãƒ¼ã‚¿ã‚’å·®åˆ†è¨ˆç®—ã§å–å¾—")
    print("="*70)

    # å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆVHC1ï½HCU12ã®å…¨æœŸï¼‰
    # MASTER_DATA_FILE ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹
    df_all = pd.read_csv(MASTER_DATA_FILE, encoding=CSV_ENCODING)
    print(f"  ğŸ“Š å…¨ä½“ãƒ‡ãƒ¼ã‚¿: {len(df_all):,} ä»¶")

    # 11æœŸåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
    # ï¼ˆå°æ–‡å­—ã«å¤‰æ›ãƒ»ç©ºç™½å‰Šé™¤ã—ã¦æ­£ç¢ºã«æ¯”è¼ƒï¼‰
    non_vhc6_emails = set(
        df_non_vhc6['Eãƒ¡ãƒ¼ãƒ«']
        .dropna()  # ç©ºæ¬„ã‚’å‰Šé™¤
        .str.lower()  # å°æ–‡å­—ã«å¤‰æ›
        .str.strip()  # å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
    )

    # å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
    all_emails = set(
        df_all['Eãƒ¡ãƒ¼ãƒ«']
        .dropna()
        .str.lower()
        .str.strip()
    )

    # å·®åˆ†è¨ˆç®—: å…¨ä½“ - 11æœŸåˆ† = VHC6æœŸ
    # ã‚»ãƒƒãƒˆæ¼”ç®—ã‚’ä½¿ã£ã¦ã€å…¨ä½“ã‹ã‚‰11æœŸåˆ†ã‚’å¼•ã
    vhc6_emails = all_emails - non_vhc6_emails

    print(f"  ğŸ“Š 11æœŸåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ•°: {len(non_vhc6_emails):,} ä»¶")
    print(f"  ğŸ“Š å…¨ä½“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ•°: {len(all_emails):,} ä»¶")
    print(f"  ğŸ“Š VHC6æœŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ•°ï¼ˆå·®åˆ†ï¼‰: {len(vhc6_emails):,} ä»¶")

    # VHC6æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    # isin() ã‚’ä½¿ã£ã¦ã€vhc6_emails ã«å«ã¾ã‚Œã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã ã‘ã‚’æŠ½å‡º
    df_vhc6 = df_all[
        df_all['Eãƒ¡ãƒ¼ãƒ«']
        .str.lower()
        .str.strip()
        .isin(vhc6_emails)
    ].copy()

    # å—è¬›æœŸã¨æœŸ_ç•ªå·ã‚’è¨­å®š
    df_vhc6['å—è¬›æœŸ'] = 'VHC6'
    df_vhc6['æœŸ_ç•ªå·'] = 6

    print(f"\n  âœ… VHC6æœŸï¼ˆå·®åˆ†è¨ˆç®—ï¼‰: {len(df_vhc6):,} ä»¶")

    return df_vhc6, df_all


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—3ã€‘å…¨12æœŸã‚’çµ±åˆ
# =========================================================================

def merge_all_periods(df_non_vhc6, df_vhc6):
    """
    11æœŸåˆ† + VHC6æœŸ = 12æœŸåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. 11æœŸåˆ†ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆdf_non_vhc6ï¼‰ã¨VHC6æœŸã®ãƒ‡ãƒ¼ã‚¿ï¼ˆdf_vhc6ï¼‰ã‚’çµåˆ
    2. 1ã¤ã®å¤§ããªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«ã¾ã¨ã‚ã‚‹

    ã€æ³¨æ„ã€‘
    ã“ã®æ™‚ç‚¹ã§ã¯é‡è¤‡ãŒã‚ã‚Šã¾ã™ï¼ˆ1äººãŒè¤‡æ•°æœŸã«å‚åŠ ã—ã¦ã„ã‚‹å ´åˆï¼‰
    é‡è¤‡å‰Šé™¤ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã„ã¾ã™ã€‚

    å¼•æ•°:
        df_non_vhc6 (pd.DataFrame): VHC6ã‚’é™¤ã11æœŸåˆ†ã®ãƒ‡ãƒ¼ã‚¿
        df_vhc6 (pd.DataFrame): VHC6æœŸã®ãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        pd.DataFrame: å…¨12æœŸã®ãƒ‡ãƒ¼ã‚¿ï¼ˆé‡è¤‡ã‚ã‚Šï¼‰
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—3ã€‘å…¨12æœŸã‚’çµ±åˆ")
    print("="*70)

    # 11æœŸåˆ† + VHC6æœŸ = 12æœŸåˆ†
    # pd.concat() ã§2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç¸¦ã«çµåˆ
    df_all_periods = pd.concat([df_non_vhc6, df_vhc6], ignore_index=True)

    print(f"  ğŸ“Š å…¨12æœŸã®ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: {len(df_all_periods):,} ä»¶ï¼ˆé‡è¤‡ã‚ã‚Šï¼‰")

    return df_all_periods


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—4ã€‘æ°åæ­£è¦åŒ–ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰å‡¦ç†
# =========================================================================

def preprocess_data(df):
    """
    ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã‚’è¡Œã†

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. æ°åã‚’ä½œæˆï¼ˆå§“ + åï¼‰
    2. æ°åã‚’æ­£è¦åŒ–ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãƒ»è¨˜å·ã‚’å‰Šé™¤ï¼‰
    3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å°æ–‡å­—ã«çµ±ä¸€

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    å¾Œã§é‡è¤‡å‰Šé™¤ã‚’è¡Œã†ãŸã‚ã€çµ±ä¸€ã•ã‚ŒãŸå½¢å¼ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    ä¾‹: ã€Œæœ€ä¸Š_è¼æœªå­ã€ã¨ã€Œæœ€ä¸Š è¼æœªå­ã€ã‚’åŒä¸€äººç‰©ã¨ã—ã¦èªè­˜ã™ã‚‹

    å¼•æ•°:
        df (pd.DataFrame): å…¨12æœŸã®ãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        pd.DataFrame: å‰å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—4ã€‘æ°åæ­£è¦åŒ–ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰å‡¦ç†")
    print("="*70)

    # å§“ã¨åã‚’çµåˆã—ã¦æ°åã‚’ä½œæˆ
    df['å§“'] = df['å§“'].fillna('')  # ç©ºæ¬„ã¯ç©ºæ–‡å­—ã«å¤‰æ›
    df['å'] = df['å'].fillna('')
    df['æ°å'] = df['å§“'] + df['å']

    # æ°åã‚’æ­£è¦åŒ–ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãƒ»è¨˜å·ã‚’å‰Šé™¤ï¼‰
    # normalize_name() ã¯ 03_data_utils.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é–¢æ•°
    df['æ°å_key'] = df['æ°å'].apply(normalize_name)

    # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å°æ–‡å­—ã«çµ±ä¸€
    df['Eãƒ¡ãƒ¼ãƒ«'] = df['Eãƒ¡ãƒ¼ãƒ«'].str.lower().str.strip()

    print(f"  âœ… æ°åã‚’ä½œæˆãƒ»æ­£è¦åŒ–ã—ã¾ã—ãŸ")
    print(f"  âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å°æ–‡å­—ã«çµ±ä¸€ã—ã¾ã—ãŸ")

    # æ°åã®æ­£è¦åŒ–ä¾‹ã‚’è¡¨ç¤º
    print("\n  ã€æ°åã®æ­£è¦åŒ–ä¾‹ã€‘")
    # å…ƒã®æ°åã¨æ­£è¦åŒ–å¾Œã®æ°åãŒç•°ãªã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
    sample_df = df[df['æ°å'] != df['æ°å_key']].head(5)
    for _, row in sample_df.iterrows():
        print(f"    å…ƒã®æ°å: ã€Œ{row['æ°å']}ã€ â†’ æ­£è¦åŒ–å¾Œ: ã€Œ{row['æ°å_key']}ã€")

    return df


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—5ã€‘é‡è¤‡å‰Šé™¤ï¼ˆæœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰
# =========================================================================

def deduplicate_data(df):
    """
    é‡è¤‡ã‚’å‰Šé™¤ã—ã€æœ€å¾Œã«å—è¬›ã—ãŸæœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãªã„ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†ã‘ã‚‹
    2. å„ã‚°ãƒ«ãƒ¼ãƒ—ã§æœŸ_ç•ªå·ã‚’é™é †ã‚½ãƒ¼ãƒˆï¼ˆæœ€å¾Œã®æœŸãŒå…ˆé ­ã«æ¥ã‚‹ï¼‰
    3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯æ°åã§é‡è¤‡å‰Šé™¤ï¼ˆæœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰=æœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰
    4. 2ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’çµ±åˆ

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    1äººãŒè¤‡æ•°æœŸã«å‚åŠ ã—ã¦ã„ã‚‹å ´åˆã€æœ€å¾Œã«å—è¬›ã—ãŸæœŸã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’æ®‹ã—ã¾ã™ã€‚
    ä¾‹: VHC3ã¨HCU10ã‚’å—è¬›ã—ã¦ã„ã‚‹äººã¯ã€HCU10ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’æ®‹ã™

    å¼•æ•°:
        df (pd.DataFrame): å…¨12æœŸã®ãƒ‡ãƒ¼ã‚¿ï¼ˆé‡è¤‡ã‚ã‚Šï¼‰

    æˆ»ã‚Šå€¤:
        pd.DataFrame: é‡è¤‡å‰Šé™¤å¾Œã®ãƒ‡ãƒ¼ã‚¿
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—5ã€‘é‡è¤‡å‰Šé™¤ï¼ˆæœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰")
    print("="*70)

    # --- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ã‚Šã®ã‚°ãƒ«ãƒ¼ãƒ— ---
    df_with_email = df[df['Eãƒ¡ãƒ¼ãƒ«'].notna() & (df['Eãƒ¡ãƒ¼ãƒ«'] != '')].copy()
    print(f"  ğŸ“Š ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ã‚Š: {len(df_with_email):,} ä»¶")

    # æœŸ_ç•ªå·ã‚’é™é †ã‚½ãƒ¼ãƒˆï¼ˆæœ€å¾Œã®æœŸãŒå…ˆé ­ã«æ¥ã‚‹ï¼‰
    # ascending=False ã§é™é †ï¼ˆ12, 11, 10, ...ã®é †ï¼‰
    df_with_email_sorted = df_with_email.sort_values('æœŸ_ç•ªå·', ascending=False)

    # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§é‡è¤‡å‰Šé™¤ï¼ˆæœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰=æœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰
    # keep='first' ã§æœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆ=æœ€å¾Œã®æœŸï¼‰ã‚’ä¿æŒ
    df_email_dedup = df_with_email_sorted.drop_duplicates(subset=['Eãƒ¡ãƒ¼ãƒ«'], keep='first')

    print(f"  âœ… é‡è¤‡å‰Šé™¤å¾Œ: {len(df_email_dedup):,} ä»¶")

    # --- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã—ã®ã‚°ãƒ«ãƒ¼ãƒ— ---
    df_no_email = df[df['Eãƒ¡ãƒ¼ãƒ«'].isna() | (df['Eãƒ¡ãƒ¼ãƒ«'] == '')].copy()
    print(f"\n  ğŸ“Š ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã—: {len(df_no_email):,} ä»¶")

    # æœŸ_ç•ªå·ã‚’é™é †ã‚½ãƒ¼ãƒˆ
    df_no_email_sorted = df_no_email.sort_values('æœŸ_ç•ªå·', ascending=False)

    # æ°åã§é‡è¤‡å‰Šé™¤
    df_no_email_dedup = df_no_email_sorted.drop_duplicates(subset=['æ°å_key'], keep='first')

    print(f"  âœ… é‡è¤‡å‰Šé™¤å¾Œ: {len(df_no_email_dedup):,} ä»¶")

    # ä¸¡ã‚°ãƒ«ãƒ¼ãƒ—ã‚’çµ±åˆ
    df_final = pd.concat([df_email_dedup, df_no_email_dedup], ignore_index=True)

    print(f"\n  ğŸ“Š æœ€çµ‚é¡§å®¢æ•°: {len(df_final):,} ä»¶")

    # æ¤œè¨¼: æœ€å¾Œã®æœŸã‚’ä¿æŒã—ã¦ã„ã‚‹ã‹ï¼ˆã‚µãƒ³ãƒ—ãƒ«5ä»¶ï¼‰
    print("\n  ã€æ¤œè¨¼ã€‘æœ€å¾Œã®æœŸã‚’ä¿æŒã—ã¦ã„ã‚‹ã‹ï¼ˆã‚µãƒ³ãƒ—ãƒ«5ä»¶ï¼‰")
    # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰5ä»¶ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
    sample_emails = df_final[df_final['Eãƒ¡ãƒ¼ãƒ«'].notna()]['Eãƒ¡ãƒ¼ãƒ«'].sample(min(5, len(df_final)))

    for email in sample_emails:
        # å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã™ã¹ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        records = df[df['Eãƒ¡ãƒ¼ãƒ«'] == email]
        # å‚åŠ ã—ãŸæœŸã®ãƒªã‚¹ãƒˆ
        periods = sorted(records['æœŸ_ç•ªå·'].tolist())
        # ä¿æŒã•ã‚ŒãŸæœŸ
        kept_period = df_final[df_final['Eãƒ¡ãƒ¼ãƒ«'] == email]['æœŸ_ç•ªå·'].values[0]
        print(f"    {email}: å‚åŠ æœŸ={periods} â†’ ä¿æŒ={kept_period}")

    return df_final


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—6ã€‘éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
# =========================================================================

def merge_prefecture_data(df_final, df_all):
    """
    ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨ä½“ãƒ‡ãƒ¼ã‚¿ï¼‰ã‹ã‚‰éƒ½é“åºœçœŒæƒ…å ±ã‚’å–å¾—
    2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚­ãƒ¼ã«ãƒãƒ¼ã‚¸
    3. éƒ½é“åºœçœŒï¼åœ°åŸŸã€å¸‚åŒºç”ºæ‘ã€ç•ªåœ°ã®æƒ…å ±ã‚’è¿½åŠ 

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    å„æœŸã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯éƒ½é“åºœçœŒæƒ…å ±ãŒä¸å®Œå…¨ãªå ´åˆãŒã‚ã‚‹ãŸã‚ã€
    ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ­£ç¢ºãªæƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

    å¼•æ•°:
        df_final (pd.DataFrame): é‡è¤‡å‰Šé™¤å¾Œã®ãƒ‡ãƒ¼ã‚¿
        df_all (pd.DataFrame): ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨ä½“ãƒ‡ãƒ¼ã‚¿ï¼‰

    æˆ»ã‚Šå€¤:
        pd.DataFrame: éƒ½é“åºœçœŒæƒ…å ±ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—6ã€‘éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸")
    print("="*70)

    # ãƒãƒ¼ã‚¸ç”¨ã®ã‚­ãƒ¼ã‚’ä½œæˆï¼ˆå°æ–‡å­—ãƒ»ç©ºç™½å‰Šé™¤ï¼‰
    df_final['Eãƒ¡ãƒ¼ãƒ«_key'] = df_final['Eãƒ¡ãƒ¼ãƒ«'].str.lower().str.strip()
    df_all['Eãƒ¡ãƒ¼ãƒ«_key'] = df_all['Eãƒ¡ãƒ¼ãƒ«'].str.lower().str.strip()

    # éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
    # left: df_final ã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿æŒ
    # how='left': å·¦å´ï¼ˆdf_finalï¼‰ã®ã™ã¹ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿æŒ
    # suffixes: åˆ—åãŒé‡è¤‡ã—ãŸå ´åˆã®æ¥å°¾è¾
    df_merged = df_final.merge(
        df_all[['Eãƒ¡ãƒ¼ãƒ«_key', 'éƒ½é“åºœçœŒï¼åœ°åŸŸ', 'å¸‚åŒºç”ºæ‘', 'ç•ªåœ°']],
        on='Eãƒ¡ãƒ¼ãƒ«_key',
        how='left',
        suffixes=('', '_master')
    )

    print(f"  âœ… éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸ")

    return df_merged


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—7ã€‘éƒ½é“åºœçœŒã‚’æŠ½å‡º
# =========================================================================

def extract_prefecture_column(df):
    """
    ä½æ‰€ã‹ã‚‰éƒ½é“åºœçœŒã‚’æŠ½å‡ºã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. éƒ½é“åºœçœŒï¼åœ°åŸŸã®åˆ—ã‹ã‚‰éƒ½é“åºœçœŒã‚’æŠ½å‡º
    2. æŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯ã€å¸‚åŒºç”ºæ‘ã‹ã‚‰æŠ½å‡º
    3. ãã‚Œã§ã‚‚ãªã„å ´åˆã¯ã€ç•ªåœ°ã‹ã‚‰æŠ½å‡º

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    åœ°åŸŸåˆ¥é›†è¨ˆã‚’è¡Œã†ãŸã‚ã€éƒ½é“åºœçœŒã‚’æ­£ç¢ºã«å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

    ã€ä¾‹ã€‘
    éƒ½é“åºœçœŒï¼åœ°åŸŸ: "æ±äº¬éƒ½æ¸‹è°·åŒº..." â†’ éƒ½é“åºœçœŒ: "æ±äº¬éƒ½"
    å¸‚åŒºç”ºæ‘: "æ¨ªæµœå¸‚..." â†’ éƒ½é“åºœçœŒ: "ç¥å¥ˆå·çœŒ"ï¼ˆéƒ½é“åºœçœŒï¼åœ°åŸŸãŒç©ºæ¬„ã®å ´åˆï¼‰

    å¼•æ•°:
        df (pd.DataFrame): éƒ½é“åºœçœŒæƒ…å ±ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        pd.DataFrame: éƒ½é“åºœçœŒãŒæŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—7ã€‘éƒ½é“åºœçœŒã‚’æŠ½å‡º")
    print("="*70)

    # éƒ½é“åºœçœŒï¼åœ°åŸŸã‹ã‚‰æŠ½å‡º
    # extract_prefecture() ã¯ 03_data_utils.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é–¢æ•°
    # PREFECTURES ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆ
    df['éƒ½é“åºœçœŒ'] = df['éƒ½é“åºœçœŒï¼åœ°åŸŸ'].apply(lambda x: extract_prefecture(x, PREFECTURES))

    # æŠ½å‡ºã§ããªã‹ã£ãŸå ´åˆã¯ã€å¸‚åŒºç”ºæ‘ã‹ã‚‰æŠ½å‡º
    mask_no_pref = df['éƒ½é“åºœçœŒ'].isna()  # éƒ½é“åºœçœŒãŒNoneã®ãƒ¬ã‚³ãƒ¼ãƒ‰
    df.loc[mask_no_pref, 'éƒ½é“åºœçœŒ'] = df.loc[mask_no_pref, 'å¸‚åŒºç”ºæ‘'].apply(lambda x: extract_prefecture(x, PREFECTURES))

    # ãã‚Œã§ã‚‚ãªã„å ´åˆã¯ã€ç•ªåœ°ã‹ã‚‰æŠ½å‡º
    mask_no_pref = df['éƒ½é“åºœçœŒ'].isna()
    df.loc[mask_no_pref, 'éƒ½é“åºœçœŒ'] = df.loc[mask_no_pref, 'ç•ªåœ°'].apply(lambda x: extract_prefecture(x, PREFECTURES))

    # éƒ½é“åºœçœŒãŒå–å¾—ã§ããŸä»¶æ•°
    pref_count = df['éƒ½é“åºœçœŒ'].notna().sum()
    pref_rate = pref_count / len(df) * 100

    print(f"  âœ… éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {pref_count:,} ä»¶ / {len(df):,} ä»¶ ({pref_rate:.1f}%)")

    # éƒ½é“åºœçœŒåˆ¥ã®äººæ•°ï¼ˆä¸Šä½10ä»¶ï¼‰
    print("\n  ã€éƒ½é“åºœçœŒåˆ¥ã®äººæ•°ï¼ˆä¸Šä½10ä»¶ï¼‰ã€‘")
    top_prefs = df['éƒ½é“åºœçœŒ'].value_counts().head(10)
    for i, (pref, count) in enumerate(top_prefs.items(), 1):
        print(f"    {i}. {pref}: {count:,} äºº")

    return df


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—8ã€‘åœ°åŸŸåˆ¥é›†è¨ˆ
# =========================================================================

def regional_summary(df):
    """
    åœ°åŸŸåˆ¥ã®é›†è¨ˆã‚’è¡Œã†

    ã€é›†è¨ˆé …ç›®ã€‘
    A. æ±äº¬éƒ½åœ¨ä½
    B. åŸ¼ç‰ãƒ»åƒè‘‰ãƒ»ç¥å¥ˆå·åœ¨ä½
    C. 7æœŸä»¥é™ + æ±äº¬éƒ½åœ¨ä½
    D. 7æœŸä»¥é™ + è¿‘çœŒåœ¨ä½

    ã€ãªãœã“ã‚Œã‚‰ã®é›†è¨ˆãŒå¿…è¦ã‹ã€‘
    æ±äº¬éƒ½ã¨ãã®è¿‘éš£çœŒã¯ã€å–¶æ¥­æ´»å‹•ã®å„ªå…ˆã‚¨ãƒªã‚¢ã§ã™ã€‚
    ç‰¹ã«7æœŸä»¥é™ï¼ˆæœ€è¿‘ã®å—è¬›ç”Ÿï¼‰ã®äººæ•°ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã§ã€
    å–¶æ¥­è¨ˆç”»ã‚’ç«‹ã¦ã‚„ã™ããªã‚Šã¾ã™ã€‚

    å¼•æ•°:
        df (pd.DataFrame): éƒ½é“åºœçœŒãŒæŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        dict: åœ°åŸŸåˆ¥é›†è¨ˆçµæœ
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—8ã€‘åœ°åŸŸåˆ¥é›†è¨ˆ")
    print("="*70)

    # A. æ±äº¬éƒ½åœ¨ä½
    A = (df['éƒ½é“åºœçœŒ'] == 'æ±äº¬éƒ½').sum()

    # B. åŸ¼ç‰ãƒ»åƒè‘‰ãƒ»ç¥å¥ˆå·åœ¨ä½
    # KANTO_NEARBY ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆ
    B = df['éƒ½é“åºœçœŒ'].isin(KANTO_NEARBY).sum()

    # C. 7æœŸä»¥é™ + æ±äº¬éƒ½åœ¨ä½
    C = ((df['æœŸ_ç•ªå·'] >= PRIORITY_2_PERIOD_MIN) & (df['éƒ½é“åºœçœŒ'] == 'æ±äº¬éƒ½')).sum()

    # D. 7æœŸä»¥é™ + è¿‘çœŒåœ¨ä½
    D = ((df['æœŸ_ç•ªå·'] >= PRIORITY_2_PERIOD_MIN) &
         (df['éƒ½é“åºœçœŒ'].isin(KANTO_NEARBY))).sum()

    print(f"  A. æ±äº¬éƒ½åœ¨ä½: {A:,} äºº")
    print(f"  B. åŸ¼ç‰ãƒ»åƒè‘‰ãƒ»ç¥å¥ˆå·åœ¨ä½: {B:,} äºº")
    print(f"  C. 7æœŸä»¥é™ + æ±äº¬éƒ½åœ¨ä½: {C:,} äºº")
    print(f"  D. 7æœŸä»¥é™ + è¿‘çœŒåœ¨ä½: {D:,} äºº")

    return {
        'A': A,
        'B': B,
        'C': C,
        'D': D,
    }


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—9ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
# =========================================================================

def merge_survey_data(df):
    """
    å’æ¥­å¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®å›ç­”æƒ…å ±ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. 7ï½11æœŸã®å’æ¥­å¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    2. å›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
    3. å›ç­”è€…ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆTrue/Falseï¼‰

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    å„ªå…ˆé †ä½2ã®åˆ¤å®šã«å¿…è¦ã§ã™ï¼ˆ7ï½11æœŸ + ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ï¼‰ã€‚
    ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã¯ã€POSSIMã¨ã®é–¢ä¿‚æ€§ãŒå¼·ã„ã¨åˆ¤æ–­ã—ã¾ã™ã€‚

    å¼•æ•°:
        df (pd.DataFrame): éƒ½é“åºœçœŒãŒæŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        tuple: (ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿, ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚»ãƒƒãƒˆ)
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—9ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒãƒ¼ã‚¸")
    print("="*70)

    survey_emails = set()  # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥ã‚Œã‚‹ç®±

    # å„æœŸã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    # SURVEY_FILES ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¾æ›¸
    for period, filepath in SURVEY_FILES.items():
        try:
            # extract_survey_emails() ã¯ 03_data_utils.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é–¢æ•°
            emails = extract_survey_emails(filepath, email_column_index=1)

            # ã‚»ãƒƒãƒˆã«è¿½åŠ ï¼ˆè‡ªå‹•çš„ã«é‡è¤‡ãŒå‰Šé™¤ã•ã‚Œã‚‹ï¼‰
            survey_emails.update(emails)

            print(f"  âœ… HCU{period}æœŸ: {len(emails):,} ä»¶")

        except FileNotFoundError:
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
            print(f"  âš ï¸ HCU{period}æœŸ: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        except Exception as e:
            # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
            print(f"  âš ï¸ HCU{period}æœŸ: ã‚¨ãƒ©ãƒ¼ - {e}")

    # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
    df['ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'] = df['Eãƒ¡ãƒ¼ãƒ«'].isin(survey_emails)

    # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…æ•°
    survey_count = df['ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'].sum()
    survey_rate = survey_count / len(df) * 100

    print(f"\n  ğŸ“Š ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…æ•°: {survey_count:,} äºº / {len(df):,} äºº ({survey_rate:.1f}%)")

    return df, survey_emails


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—10ã€‘å„ªå…ˆé †ä½ã‚’ä»˜ä¸
# =========================================================================

def assign_priority(df, survey_emails):
    """
    å„ªå…ˆé †ä½ã‚’è¨ˆç®—ã—ã¦ä»˜ä¸ã™ã‚‹

    ã€å®šç¾©ã€‘
    å„ªå…ˆé †ä½1: æœ€å¾Œã«å‚åŠ ã—ãŸã®ãŒ12æœŸ
    å„ªå…ˆé †ä½2: 7ï½11æœŸ ã‹ã¤ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…
    å„ªå…ˆé †ä½3: 7ï½11æœŸ ã‹ã¤ æœªå›ç­”
    å„ªå…ˆé †ä½4: 1ï½6æœŸ

    ã€ãªãœã“ã®é †ç•ªãªã®ã‹ã€‘
    - 12æœŸç”Ÿã¯æœ€æ–°ã®å—è¬›ç”Ÿãªã®ã§ã€æœ€ã‚‚å„ªå…ˆåº¦ãŒé«˜ã„
    - 7ï½11æœŸã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã¯ã€é–¢ä¿‚æ€§ãŒå¼·ã„ã¨åˆ¤æ–­
    - 1ï½6æœŸã¯å—è¬›ã‹ã‚‰æ™‚é–“ãŒçµŒã£ã¦ã„ã‚‹ãŸã‚ã€å„ªå…ˆåº¦ã¯ä½ã„

    å¼•æ•°:
        df (pd.DataFrame): ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
        survey_emails (set): ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚»ãƒƒãƒˆ

    æˆ»ã‚Šå€¤:
        pd.DataFrame: å„ªå…ˆé †ä½ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—10ã€‘å„ªå…ˆé †ä½ã‚’ä»˜ä¸")
    print("="*70)

    # å„ªå…ˆé †ä½ã‚’è¨ˆç®—
    # calculate_priority() ã¯ 03_data_utils.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é–¢æ•°
    df['å„ªå…ˆé †ä½'] = df.apply(lambda row: calculate_priority(row, survey_emails), axis=1)

    # å„ªå…ˆé †ä½åˆ¥ã®äººæ•°
    priority_counts = df['å„ªå…ˆé †ä½'].value_counts().sort_index()

    print("\n  ã€å„ªå…ˆé †ä½åˆ¥ã®äººæ•°ã€‘")
    # PRIORITY_LABELS ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¾æ›¸
    for priority in [1, 2, 3, 4]:
        count = priority_counts.get(priority, 0)
        print(f"    {PRIORITY_LABELS[priority]}: {count:,} äºº")

    print(f"    åˆè¨ˆ: {len(df):,} äºº")

    return df


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—11ã€‘é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®æ•´å½¢ã¨ä½æ‰€ã®ä½œæˆ
# =========================================================================

def format_contact_info(df):
    """
    é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã‚’æ•´å½¢ã—ã€ä½æ‰€ã‚’ä½œæˆã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1. é›»è©±ç•ªå·ã‚’æ•´å½¢ï¼ˆ090-1234-5678å½¢å¼ï¼‰
    2. éƒµä¾¿ç•ªå·ã‚’æ•´å½¢ï¼ˆ123-4567å½¢å¼ï¼‰
    3. ä½æ‰€ã‚’ä½œæˆï¼ˆéƒ½é“åºœçœŒ + å¸‚åŒºç”ºæ‘ + ç•ªåœ°ï¼‰

    ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
    è¦‹ã‚„ã™ãçµ±ä¸€ã•ã‚ŒãŸå½¢å¼ã«ã™ã‚‹ã“ã¨ã§ã€
    å–¶æ¥­æ´»å‹•ã§ä½¿ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚

    å¼•æ•°:
        df (pd.DataFrame): å„ªå…ˆé †ä½ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        pd.DataFrame: æ•´å½¢å¾Œã®ãƒ‡ãƒ¼ã‚¿
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—11ã€‘é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®æ•´å½¢ã¨ä½æ‰€ã®ä½œæˆ")
    print("="*70)

    # é›»è©±ç•ªå·ã‚’æ•´å½¢
    # format_phone() ã¯ 03_data_utils.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é–¢æ•°
    df['é›»è©±ç•ªå·_ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ'] = df['é›»è©±ç•ªå·'].apply(format_phone)

    # éƒµä¾¿ç•ªå·ã‚’æ•´å½¢
    # format_postal() ã¯ 03_data_utils.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹é–¢æ•°
    df['éƒµä¾¿ç•ªå·_ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ'] = df['éƒµä¾¿ç•ªå·'].apply(format_postal)

    # ä½æ‰€ã‚’ä½œæˆ
    df['ä½æ‰€'] = (
        df['éƒ½é“åºœçœŒï¼åœ°åŸŸ'].fillna('') +
        df['å¸‚åŒºç”ºæ‘'].fillna('') +
        df['ç•ªåœ°'].fillna('')
    )

    # ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
    phone_count = df['é›»è©±ç•ªå·'].notna().sum()
    phone_rate = phone_count / len(df) * 100

    postal_count = df['éƒµä¾¿ç•ªå·'].notna().sum()
    postal_rate = postal_count / len(df) * 100

    address_count = df['ä½æ‰€'].notna().sum()
    address_rate = address_count / len(df) * 100

    email_count = df['Eãƒ¡ãƒ¼ãƒ«'].notna().sum()
    email_rate = email_count / len(df) * 100

    print(f"  âœ… é›»è©±ç•ªå·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {phone_count:,} ä»¶ / {len(df):,} ä»¶ ({phone_rate:.1f}%)")
    print(f"  âœ… éƒµä¾¿ç•ªå·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {postal_count:,} ä»¶ / {len(df):,} ä»¶ ({postal_rate:.1f}%)")
    print(f"  âœ… ä½æ‰€ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {address_count:,} ä»¶ / {len(df):,} ä»¶ ({address_rate:.1f}%)")
    print(f"  âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {email_count:,} ä»¶ / {len(df):,} ä»¶ ({email_rate:.1f}%)")

    # ä½æ‰€ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
    print("\n  ã€ä½æ‰€ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã€‘")
    address_counts = df['ä½æ‰€'].value_counts()
    duplicates = address_counts[address_counts > 1]

    if len(duplicates) > 0:
        print(f"  âš ï¸ é‡è¤‡ä½æ‰€ãŒ {len(duplicates):,} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ")
        print("\n  ä¸Šä½ 10 ä»¶:")
        for i, (address, count) in enumerate(duplicates.head(10).items(), 1):
            display_address = address if address else 'ï¼ˆç©ºæ¬„ï¼‰'
            print(f"    {i}. {display_address}: {count:,} ä»¶")
    else:
        print(f"  âœ… é‡è¤‡ä½æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“")

    return df


# =========================================================================
# ã€ã‚¹ãƒ†ãƒƒãƒ—12ã€‘Excelå‡ºåŠ›ï¼ˆ4ã‚·ãƒ¼ãƒˆæ§‹æˆï¼‰
# =========================================================================

def create_excel_output(df, regional_stats):
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚‹ï¼ˆ4ã‚·ãƒ¼ãƒˆæ§‹æˆï¼‰

    ã€ã‚·ãƒ¼ãƒˆæ§‹æˆã€‘
    1. å–¶æ¥­ãƒªã‚¹ãƒˆ: å„ªå…ˆé †ä½ä»˜ãé¡§å®¢ãƒªã‚¹ãƒˆ
    2. åœ°åŸŸåˆ¥é›†è¨ˆçµæœ: åœ°åŸŸåˆ¥ã®äººæ•°é›†è¨ˆ
    3. å„ªå…ˆé †ä½åˆ¥ã®äººæ•°: å„ªå…ˆé †ä½åˆ¥ã®äººæ•°é›†è¨ˆ
    4. å„ç¨®ãƒã‚§ãƒƒã‚¯é …ç›®: ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯çµæœ

    ã€ãªãœ4ã‚·ãƒ¼ãƒˆã«åˆ†ã‘ã‚‹ã®ã‹ã€‘
    - ã‚·ãƒ¼ãƒˆ1: å®Ÿéš›ã«å–¶æ¥­ã§ä½¿ã†ãƒªã‚¹ãƒˆ
    - ã‚·ãƒ¼ãƒˆ2: åœ°åŸŸæˆ¦ç•¥ã‚’ç«‹ã¦ã‚‹ãŸã‚ã®é›†è¨ˆ
    - ã‚·ãƒ¼ãƒˆ3: å„ªå…ˆé †ä½åˆ¥ã®æˆ¦ç•¥ã‚’ç«‹ã¦ã‚‹ãŸã‚ã®é›†è¨ˆ
    - ã‚·ãƒ¼ãƒˆ4: ãƒ‡ãƒ¼ã‚¿å“è³ªã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒã‚§ãƒƒã‚¯

    å¼•æ•°:
        df (pd.DataFrame): æ•´å½¢å¾Œã®ãƒ‡ãƒ¼ã‚¿
        regional_stats (dict): åœ°åŸŸåˆ¥é›†è¨ˆçµæœ
    """

    print("\n" + "="*70)
    print("ã€ã‚¹ãƒ†ãƒƒãƒ—12ã€‘Excelå‡ºåŠ›ï¼ˆ4ã‚·ãƒ¼ãƒˆæ§‹æˆï¼‰")
    print("="*70)

    # å‡ºåŠ›ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
    df_output = df[[
        'å„ªå…ˆé †ä½',
        'æ°å',
        'é›»è©±ç•ªå·_ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ',
        'Eãƒ¡ãƒ¼ãƒ«',
        'éƒµä¾¿ç•ªå·_ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ',
        'ä½æ‰€',
        'éƒ½é“åºœçœŒ',
        'å—è¬›æœŸ',
        'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”',
    ]].copy()

    # åˆ—åã‚’å¤‰æ›´
    df_output.columns = [
        'å„ªå…ˆé †ä½',
        'æ°å',
        'é›»è©±ç•ªå·',
        'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
        'éƒµä¾¿ç•ªå·',
        'ä½æ‰€',
        'éƒ½é“åºœçœŒ',
        'æœ€å¾Œã«å—è¬›ã—ãŸæœŸ',
        'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”',
    ]

    # å„ªå…ˆé †ä½ã§ã‚½ãƒ¼ãƒˆ
    df_output = df_output.sort_values('å„ªå…ˆé †ä½')

    # Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    # OUTPUT_FILE ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹
    # EXCEL_ENGINE ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¨­å®š
    with pd.ExcelWriter(OUTPUT_FILE, engine=EXCEL_ENGINE) as writer:

        # --- ã‚·ãƒ¼ãƒˆ1: å–¶æ¥­ãƒªã‚¹ãƒˆ ---
        print("  ğŸ“„ å–¶æ¥­ãƒªã‚¹ãƒˆã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...")
        # OUTPUT_SHEETS ã¯ 02_config.py ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹è¾æ›¸
        df_output.to_excel(writer, sheet_name=OUTPUT_SHEETS['MAIN'], index=False)

        # --- ã‚·ãƒ¼ãƒˆ2: åœ°åŸŸåˆ¥é›†è¨ˆçµæœ ---
        print("  ğŸ“„ åœ°åŸŸåˆ¥é›†è¨ˆçµæœã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...")
        df_regional = pd.DataFrame([
            {'é›†è¨ˆé …ç›®': 'A. æ±äº¬éƒ½åœ¨ä½', 'äººæ•°': regional_stats['A']},
            {'é›†è¨ˆé …ç›®': 'B. åŸ¼ç‰ãƒ»åƒè‘‰ãƒ»ç¥å¥ˆå·åœ¨ä½', 'äººæ•°': regional_stats['B']},
            {'é›†è¨ˆé …ç›®': 'C. 7æœŸä»¥é™ + æ±äº¬éƒ½åœ¨ä½', 'äººæ•°': regional_stats['C']},
            {'é›†è¨ˆé …ç›®': 'D. 7æœŸä»¥é™ + è¿‘çœŒåœ¨ä½', 'äººæ•°': regional_stats['D']},
        ])
        df_regional.to_excel(writer, sheet_name=OUTPUT_SHEETS['REGIONAL'], index=False)

        # --- ã‚·ãƒ¼ãƒˆ3: å„ªå…ˆé †ä½åˆ¥ã®äººæ•° ---
        print("  ğŸ“„ å„ªå…ˆé †ä½åˆ¥ã®äººæ•°ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...")
        priority_counts = df['å„ªå…ˆé †ä½'].value_counts().sort_index()
        df_priority = pd.DataFrame([
            {'å„ªå…ˆé †ä½': PRIORITY_LABELS[1], 'äººæ•°': priority_counts.get(1, 0)},
            {'å„ªå…ˆé †ä½': PRIORITY_LABELS[2], 'äººæ•°': priority_counts.get(2, 0)},
            {'å„ªå…ˆé †ä½': PRIORITY_LABELS[3], 'äººæ•°': priority_counts.get(3, 0)},
            {'å„ªå…ˆé †ä½': PRIORITY_LABELS[4], 'äººæ•°': priority_counts.get(4, 0)},
            {'å„ªå…ˆé †ä½': 'åˆè¨ˆ', 'äººæ•°': len(df)},
        ])
        df_priority.to_excel(writer, sheet_name=OUTPUT_SHEETS['PRIORITY'], index=False)

        # --- ã‚·ãƒ¼ãƒˆ4: å„ç¨®ãƒã‚§ãƒƒã‚¯é …ç›® ---
        print("  ğŸ“„ å„ç¨®ãƒã‚§ãƒƒã‚¯é …ç›®ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...")

        phone_count = df['é›»è©±ç•ªå·'].notna().sum()
        phone_rate = phone_count / len(df) * 100

        postal_count = df['éƒµä¾¿ç•ªå·'].notna().sum()
        postal_rate = postal_count / len(df) * 100

        address_count = df['ä½æ‰€'].notna().sum()
        address_rate = address_count / len(df) * 100

        pref_count = df['éƒ½é“åºœçœŒ'].notna().sum()
        pref_rate = pref_count / len(df) * 100

        email_count = df['Eãƒ¡ãƒ¼ãƒ«'].notna().sum()
        email_rate = email_count / len(df) * 100

        df_check = pd.DataFrame([
            {'ãƒã‚§ãƒƒã‚¯é …ç›®': 'é›»è©±ç•ªå·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°', 'ä»¶æ•°': phone_count, 'å…¨ä½“': len(df), 'å‰²åˆ(%)': f'{phone_rate:.1f}'},
            {'ãƒã‚§ãƒƒã‚¯é …ç›®': 'éƒµä¾¿ç•ªå·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°', 'ä»¶æ•°': postal_count, 'å…¨ä½“': len(df), 'å‰²åˆ(%)': f'{postal_rate:.1f}'},
            {'ãƒã‚§ãƒƒã‚¯é …ç›®': 'ä½æ‰€ãƒ‡ãƒ¼ã‚¿ä»¶æ•°', 'ä»¶æ•°': address_count, 'å…¨ä½“': len(df), 'å‰²åˆ(%)': f'{address_rate:.1f}'},
            {'ãƒã‚§ãƒƒã‚¯é …ç›®': 'éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ä»¶æ•°', 'ä»¶æ•°': pref_count, 'å…¨ä½“': len(df), 'å‰²åˆ(%)': f'{pref_rate:.1f}'},
            {'ãƒã‚§ãƒƒã‚¯é …ç›®': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‡ãƒ¼ã‚¿ä»¶æ•°', 'ä»¶æ•°': email_count, 'å…¨ä½“': len(df), 'å‰²åˆ(%)': f'{email_rate:.1f}'},
        ])
        df_check.to_excel(writer, sheet_name=OUTPUT_SHEETS['CHECK'], index=False)

        # ä½æ‰€ã®é‡è¤‡æƒ…å ±ã‚’è¿½åŠ 
        address_counts = df['ä½æ‰€'].value_counts()
        duplicates = address_counts[address_counts > 1]

        if len(duplicates) > 0:
            # ç©ºè¡Œã‚’è¿½åŠ 
            df_empty = pd.DataFrame([[''] * 4], columns=['ãƒã‚§ãƒƒã‚¯é …ç›®', 'ä»¶æ•°', 'å…¨ä½“', 'å‰²åˆ(%)'])
            df_empty.to_excel(writer, sheet_name=OUTPUT_SHEETS['CHECK'],
                            startrow=len(df_check)+2, index=False, header=False)

            # é‡è¤‡ä½æ‰€ã®ã‚¿ã‚¤ãƒˆãƒ«
            df_dup_title = pd.DataFrame([['ã€ä½æ‰€ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã€‘', '', '', '']],
                                       columns=['ãƒã‚§ãƒƒã‚¯é …ç›®', 'ä»¶æ•°', 'å…¨ä½“', 'å‰²åˆ(%)'])
            df_dup_title.to_excel(writer, sheet_name=OUTPUT_SHEETS['CHECK'],
                                 startrow=len(df_check)+3, index=False, header=False)

            # é‡è¤‡ä½æ‰€ã®æƒ…å ±
            df_dup_info = pd.DataFrame([[f'âš ï¸ é‡è¤‡ä½æ‰€ãŒ {len(duplicates):,} ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', '', '', '']],
                                      columns=['ãƒã‚§ãƒƒã‚¯é …ç›®', 'ä»¶æ•°', 'å…¨ä½“', 'å‰²åˆ(%)'])
            df_dup_info.to_excel(writer, sheet_name=OUTPUT_SHEETS['CHECK'],
                                startrow=len(df_check)+4, index=False, header=False)

            # ç©ºè¡Œ
            df_empty.to_excel(writer, sheet_name=OUTPUT_SHEETS['CHECK'],
                            startrow=len(df_check)+5, index=False, header=False)

            # é‡è¤‡ä½æ‰€ã®ä¸Šä½10ä»¶
            # âœ… ä¿®æ­£: 3åˆ—ã®DataFrameã‚’æ­£ã—ãä½œæˆï¼ˆé †ä½ã€ä½æ‰€ã€ä»¶æ•°ï¼‰
            df_dup_list = pd.DataFrame([
                {'é †ä½': f"{i+1}.", 'ä½æ‰€': address if address else 'ï¼ˆç©ºæ¬„ï¼‰', 'ä»¶æ•°': count}
                for i, (address, count) in enumerate(duplicates.head(10).items())
            ])
            # åˆ—åã¯ãã®ã¾ã¾ä½¿ç”¨ï¼ˆåˆ—åå¤‰æ›´ã¯ä¸è¦ï¼‰
            df_dup_list.to_excel(writer, sheet_name=OUTPUT_SHEETS['CHECK'],
                                startrow=len(df_check)+6, index=False)

    print(f"\n  âœ… ä¿å­˜å®Œäº†: {OUTPUT_FILE}")
    print(f"  ğŸ“Š ã‚·ãƒ¼ãƒˆæ•°: 4 ã‚·ãƒ¼ãƒˆ")
    print(f"  ğŸ“Š å–¶æ¥­ãƒªã‚¹ãƒˆä»¶æ•°: {len(df_output):,} ä»¶")


# =========================================================================
# ã€ãƒ¡ã‚¤ãƒ³å‡¦ç†ã€‘
# =========================================================================

def main():
    """
    ãƒ¡ã‚¤ãƒ³å‡¦ç†

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. å„æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆVHC1ï½5, HCU7ï½12ã®11æœŸåˆ†ï¼‰
    2. VHC6æœŸãƒ‡ãƒ¼ã‚¿ã‚’å·®åˆ†è¨ˆç®—ã§å–å¾—
    3. å…¨12æœŸã‚’çµ±åˆ
    4. æ°åæ­£è¦åŒ–ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰å‡¦ç†
    5. é‡è¤‡å‰Šé™¤ï¼ˆæœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰
    6. éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
    7. éƒ½é“åºœçœŒã‚’æŠ½å‡º
    8. åœ°åŸŸåˆ¥é›†è¨ˆ
    9. ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
    10. å„ªå…ˆé †ä½ã‚’ä»˜ä¸
    11. é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®æ•´å½¢ã¨ä½æ‰€ã®ä½œæˆ
    12. Excelå‡ºåŠ›ï¼ˆ4ã‚·ãƒ¼ãƒˆæ§‹æˆï¼‰
    """

    print("\n" + "="*70)
    print("POSSIM Customer Priority Maker - å®Ÿè¡Œé–‹å§‹")
    print("="*70)
    print(f"å®Ÿè¡Œæ—¥æ™‚: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

    try:
        # ã‚¹ãƒ†ãƒƒãƒ—1: å„æœŸã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        df_non_vhc6 = load_all_periods()

        # ã‚¹ãƒ†ãƒƒãƒ—2: VHC6æœŸãƒ‡ãƒ¼ã‚¿ã‚’å·®åˆ†è¨ˆç®—ã§å–å¾—
        df_vhc6, df_all = calculate_vhc6_data(df_non_vhc6)

        # ã‚¹ãƒ†ãƒƒãƒ—3: å…¨12æœŸã‚’çµ±åˆ
        df_all_periods = merge_all_periods(df_non_vhc6, df_vhc6)

        # ã‚¹ãƒ†ãƒƒãƒ—4: æ°åæ­£è¦åŒ–ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰å‡¦ç†
        df_preprocessed = preprocess_data(df_all_periods)

        # ã‚¹ãƒ†ãƒƒãƒ—5: é‡è¤‡å‰Šé™¤ï¼ˆæœ€å¾Œã®æœŸã‚’ä¿æŒï¼‰
        df_dedup = deduplicate_data(df_preprocessed)

        # ã‚¹ãƒ†ãƒƒãƒ—6: éƒ½é“åºœçœŒæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
        df_merged = merge_prefecture_data(df_dedup, df_all)

        # ã‚¹ãƒ†ãƒƒãƒ—7: éƒ½é“åºœçœŒã‚’æŠ½å‡º
        df_with_pref = extract_prefecture_column(df_merged)

        # ã‚¹ãƒ†ãƒƒãƒ—8: åœ°åŸŸåˆ¥é›†è¨ˆ
        regional_stats = regional_summary(df_with_pref)

        # ã‚¹ãƒ†ãƒƒãƒ—9: ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒãƒ¼ã‚¸
        df_with_survey, survey_emails = merge_survey_data(df_with_pref)

        # ã‚¹ãƒ†ãƒƒãƒ—10: å„ªå…ˆé †ä½ã‚’ä»˜ä¸
        df_with_priority = assign_priority(df_with_survey, survey_emails)

        # ã‚¹ãƒ†ãƒƒãƒ—11: é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®æ•´å½¢ã¨ä½æ‰€ã®ä½œæˆ
        df_final = format_contact_info(df_with_priority)

        # ã‚¹ãƒ†ãƒƒãƒ—12: Excelå‡ºåŠ›ï¼ˆ4ã‚·ãƒ¼ãƒˆæ§‹æˆï¼‰
        create_excel_output(df_final, regional_stats)

        print("\n" + "="*70)
        print("âœ… å‡¦ç†å®Œäº†ï¼")
        print("="*70)
        print(f"ğŸ“Š æœ€çµ‚é¡§å®¢æ•°: {len(df_final):,} ä»¶")
        print(f"ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: {OUTPUT_FILE}")
        print("="*70)

    except FileNotFoundError as e:
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - {e}")
        print("\nä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:")
        print("  1. customer_list/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å„æœŸã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹")
        print("  2. surveys/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹")

    except Exception as e:
        # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback
        traceback.print_exc()


# =========================================================================
# ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‘
# =========================================================================

if __name__ == '__main__':
    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿ã€main() ã‚’å®Ÿè¡Œ
    # python 01_main_priority.py ã§å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã«å‹•ä½œ
    main()
