#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
=========================================================================
03_data_utils.py - POSSIM Customer Priority Maker ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
=========================================================================

ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ã€‘
ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã§ç¹°ã‚Šè¿”ã—ä½¿ç”¨ã™ã‚‹é–¢æ•°ã‚’ã¾ã¨ã‚ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
å„é–¢æ•°ã¯ç‹¬ç«‹ã—ã¦ã„ã‚‹ã®ã§ã€ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ã‚‚ä½¿ãˆã¾ã™ã€‚

ã€ãªãœã“ã†ã™ã‚‹ã®ã‹ã€‘
åŒã˜å‡¦ç†ã‚’ä½•åº¦ã‚‚æ›¸ã‹ãšã€1ç®‡æ‰€ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã€
ä¿®æ­£ãŒç°¡å˜ã«ãªã‚Šã€ãƒã‚°ãŒæ¸›ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€é›»è©±ç•ªå·ã®æ•´å½¢ãƒ«ãƒ¼ãƒ«ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€
ã“ã®é–¢æ•°ã ã‘ã‚’ä¿®æ­£ã™ã‚Œã°ã€ã™ã¹ã¦ã®ç®‡æ‰€ã«åæ˜ ã•ã‚Œã¾ã™ã€‚

ã€ä½œæˆè€…ã€‘
KATSUMI KURAHASHI

ã€æœ€çµ‚æ›´æ–°æ—¥ã€‘
2025-11-05
=========================================================================
"""

import pandas as pd
import re
from pathlib import Path

# =========================================================================
# ã€1ã€‘æ°åå‡¦ç†é–¢æ•°
# =========================================================================

def normalize_name(name):
    """
    æ°åã‚’æ­£è¦åŒ–ã™ã‚‹ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãƒ»è¨˜å·ã‚’å‰Šé™¤ï¼‰

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    ã€Œæœ€ä¸Š_è¼æœªå­ã€â†’ã€Œæœ€ä¸Šè¼æœªå­ã€ã®ã‚ˆã†ã«ã€
    ã‚¹ãƒšãƒ¼ã‚¹ã‚„è¨˜å·ã‚’å‰Šé™¤ã—ã¦çµ±ä¸€ã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    åŒã˜äººãŒã€Œæœ€ä¸Š_è¼æœªå­ã€ã¨ã€Œæœ€ä¸Š è¼æœªå­ã€ã®ã‚ˆã†ã«
    é•ã†å½¢ã§ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€
    æ­£è¦åŒ–ã—ã¦åŒä¸€äººç‰©ã¨åˆ¤å®šã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

    ã€å‰Šé™¤ã™ã‚‹æ–‡å­—ã€‘
    - åŠè§’ã‚¹ãƒšãƒ¼ã‚¹
    - å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆã€€ï¼‰
    - ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼ˆ_ï¼‰
    - ãƒã‚¤ãƒ•ãƒ³ï¼ˆ-ï¼‰
    - ä¸­ç‚¹ï¼ˆãƒ»ï¼‰

    å¼•æ•°:
        name (str): æ°åï¼ˆä¾‹: "æœ€ä¸Š_è¼æœªå­"ï¼‰

    æˆ»ã‚Šå€¤:
        str: æ­£è¦åŒ–ã•ã‚ŒãŸæ°åï¼ˆä¾‹: "æœ€ä¸Šè¼æœªå­"ï¼‰

    ä½¿ç”¨ä¾‹:
        >>> normalize_name("æœ€ä¸Š_è¼æœªå­")
        "æœ€ä¸Šè¼æœªå­"
        >>> normalize_name("æœ€ä¸Š è¼æœªå­")
        "æœ€ä¸Šè¼æœªå­"
    """
    # ç©ºæ¬„ã®å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    if pd.isna(name) or name == '':
        return ''

    # æ–‡å­—åˆ—ã«å¤‰æ›
    name_str = str(name)

    # ã‚¹ãƒšãƒ¼ã‚¹ã€å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€ãƒã‚¤ãƒ•ãƒ³ã€ä¸­ç‚¹ã‚’å‰Šé™¤
    # \s = åŠè§’ã‚¹ãƒšãƒ¼ã‚¹
    # ã€€= å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹
    # _ = ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢
    # \- = ãƒã‚¤ãƒ•ãƒ³ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒå¿…è¦ï¼‰
    # ãƒ» = ä¸­ç‚¹
    name_str = re.sub(r'[\sã€€_\-ãƒ»]', '', name_str)

    # å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
    return name_str.strip()


def normalize_email(email):
    """
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ­£è¦åŒ–ã™ã‚‹ï¼ˆå°æ–‡å­—åŒ–ãƒ»å‰å¾Œç©ºç™½å‰Šé™¤ï¼‰

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    Test@Example.com â†’ test@example.com ã®ã‚ˆã†ã«ã€
    å°æ–‡å­—ã«çµ±ä¸€ã—ã¦å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ã®ã§ã€
    çµ±ä¸€ã—ã¦æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

    ä¾‹: "Test@Example.com" ã¨ "test@example.com" ã¯åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

    å¼•æ•°:
        email (str): ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

    æˆ»ã‚Šå€¤:
        str: æ­£è¦åŒ–ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

    ä½¿ç”¨ä¾‹:
        >>> normalize_email("Test@Example.com")
        "test@example.com"
        >>> normalize_email("  USER@DOMAIN.COM  ")
        "user@domain.com"
    """
    # ç©ºæ¬„ã®å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    if pd.isna(email) or email == '':
        return ''

    # å°æ–‡å­—ã«å¤‰æ›ã—ã¦å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
    return str(email).lower().strip()


# =========================================================================
# ã€2ã€‘ä½æ‰€å‡¦ç†é–¢æ•°
# =========================================================================

def extract_prefecture(address, prefectures):
    """
    ä½æ‰€ã‹ã‚‰éƒ½é“åºœçœŒã‚’æŠ½å‡ºã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    ã€Œæ±äº¬éƒ½åƒä»£ç”°åŒº...ã€â†’ã€Œæ±äº¬éƒ½ã€ã®ã‚ˆã†ã«ã€
    ä½æ‰€æ–‡å­—åˆ—ã‹ã‚‰éƒ½é“åºœçœŒåã ã‘ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    åœ°åŸŸåˆ¥ã®é›†è¨ˆã‚’ã™ã‚‹ãŸã‚ã«ã€éƒ½é“åºœçœŒãŒå¿…è¦ã§ã™ã€‚

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. ä½æ‰€æ–‡å­—åˆ—ã«ã€Œæ±äº¬éƒ½ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    2. å«ã¾ã‚Œã¦ã„ã‚Œã°ã€Œæ±äº¬éƒ½ã€ã‚’è¿”ã™
    3. å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã€æ¬¡ã®éƒ½é“åºœçœŒã‚’ãƒã‚§ãƒƒã‚¯
    4. ã™ã¹ã¦ã®éƒ½é“åºœçœŒã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°Noneã‚’è¿”ã™

    å¼•æ•°:
        address (str): ä½æ‰€ï¼ˆä¾‹: "æ±äº¬éƒ½åƒä»£ç”°åŒº..."ï¼‰
        prefectures (list): éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ

    æˆ»ã‚Šå€¤:
        str or None: éƒ½é“åºœçœŒåï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯Noneï¼‰

    ä½¿ç”¨ä¾‹:
        >>> extract_prefecture("æ±äº¬éƒ½æ¸‹è°·åŒºä»£ã€…æœ¨...", PREFECTURES)
        "æ±äº¬éƒ½"
        >>> extract_prefecture("æ¨ªæµœå¸‚...", PREFECTURES)
        None  # éƒ½é“åºœçœŒåãŒãªã„
    """
    # ç©ºæ¬„ã®å ´åˆã¯Noneã‚’è¿”ã™
    if pd.isna(address):
        return None

    # æ–‡å­—åˆ—ã«å¤‰æ›
    address = str(address)

    # éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã‚’1ã¤ãšã¤ãƒã‚§ãƒƒã‚¯
    for pref in prefectures:
        if pref in address:
            return pref

    # è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯None
    return None


def create_full_address(row):
    """
    è¤‡æ•°ã®ä½æ‰€åˆ—ã‹ã‚‰å®Œå…¨ãªä½æ‰€ã‚’ä½œæˆã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    éƒ½é“åºœçœŒã€å¸‚åŒºç”ºæ‘ã€ç•ªåœ°ã‚’çµåˆã—ã¦ã€
    1ã¤ã®å®Œå…¨ãªä½æ‰€ã‚’ä½œã‚Šã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    HubSpotã®ãƒ‡ãƒ¼ã‚¿ã¯éƒ½é“åºœçœŒã€å¸‚åŒºç”ºæ‘ã€ç•ªåœ°ãŒåˆ¥ã€…ã®åˆ—ã«
    åˆ†ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€1ã¤ã®ä½æ‰€æ–‡å­—åˆ—ã«ã¾ã¨ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

    ã€çµåˆã®ä¾‹ã€‘
    éƒ½é“åºœçœŒ: "æ±äº¬éƒ½"
    å¸‚åŒºç”ºæ‘: "æ¸‹è°·åŒº"
    ç•ªåœ°: "ä»£ã€…æœ¨1-2-3"
    â†’ ä½æ‰€: "æ±äº¬éƒ½æ¸‹è°·åŒºä»£ã€…æœ¨1-2-3"

    å¼•æ•°:
        row (pandas.Series): 1è¡Œåˆ†ã®ãƒ‡ãƒ¼ã‚¿

    æˆ»ã‚Šå€¤:
        str: å®Œå…¨ãªä½æ‰€

    ä½¿ç”¨ä¾‹:
        >>> row = {'éƒ½é“åºœçœŒï¼åœ°åŸŸ': 'æ±äº¬éƒ½', 'å¸‚åŒºç”ºæ‘': 'æ¸‹è°·åŒº', 'ç•ªåœ°': 'ä»£ã€…æœ¨1-2-3'}
        >>> create_full_address(row)
        "æ±äº¬éƒ½æ¸‹è°·åŒºä»£ã€…æœ¨1-2-3"
    """
    parts = []  # ä½æ‰€ã®ãƒ‘ãƒ¼ãƒ„ã‚’å…¥ã‚Œã‚‹ç®±

    # éƒ½é“åºœçœŒ
    if pd.notna(row.get('éƒ½é“åºœçœŒï¼åœ°åŸŸ', '')):
        parts.append(str(row['éƒ½é“åºœçœŒï¼åœ°åŸŸ']))

    # å¸‚åŒºç”ºæ‘
    if pd.notna(row.get('å¸‚åŒºç”ºæ‘', '')):
        parts.append(str(row['å¸‚åŒºç”ºæ‘']))

    # ç•ªåœ°
    if pd.notna(row.get('ç•ªåœ°', '')):
        parts.append(str(row['ç•ªåœ°']))

    # çµåˆã—ã¦è¿”ã™
    return ''.join(parts)


# =========================================================================
# ã€3ã€‘é›»è©±ç•ªå·ãƒ»éƒµä¾¿ç•ªå·ã®æ•´å½¢é–¢æ•°
# =========================================================================

def format_phone(phone):
    """
    é›»è©±ç•ªå·ã‚’æ•´å½¢ã™ã‚‹ï¼ˆ090-1234-5678å½¢å¼ï¼‰

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    09012345678 â†’ 090-1234-5678 ã®ã‚ˆã†ã«ã€
    ãƒã‚¤ãƒ•ãƒ³ã‚’å…¥ã‚Œã¦è¦‹ã‚„ã™ãã—ã¾ã™ã€‚

    ã€å¯¾å¿œå½¢å¼ã€‘
    - 11æ¡: 090-1234-5678ï¼ˆæºå¸¯é›»è©±ï¼‰
    - 10æ¡: 03-1234-5678ï¼ˆå›ºå®šé›»è©±ï¼‰
    - ãã®ä»–: ãã®ã¾ã¾è¿”ã™

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. æ•°å­—ä»¥å¤–ã®æ–‡å­—ã‚’å‰Šé™¤ï¼ˆãƒã‚¤ãƒ•ãƒ³ã€ã‚«ãƒƒã‚³ãªã©ï¼‰
    2. æ¡æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    3. 11æ¡ãªã‚‰ 090-1234-5678 å½¢å¼
    4. 10æ¡ãªã‚‰ 03-1234-5678 å½¢å¼

    å¼•æ•°:
        phone (str): é›»è©±ç•ªå·

    æˆ»ã‚Šå€¤:
        str: æ•´å½¢ã•ã‚ŒãŸé›»è©±ç•ªå·

    ä½¿ç”¨ä¾‹:
        >>> format_phone("09012345678")
        "090-1234-5678"
        >>> format_phone("03-1234-5678")
        "03-1234-5678"
        >>> format_phone("(090)1234-5678")
        "090-1234-5678"
    """
    # ç©ºæ¬„ã®å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    if pd.isna(phone) or phone == '':
        return ''

    # æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
    # \D = æ•°å­—ä»¥å¤–ã®æ–‡å­—ï¼ˆãƒã‚¤ãƒ•ãƒ³ã€ã‚«ãƒƒã‚³ã€ã‚¹ãƒšãƒ¼ã‚¹ãªã©ï¼‰
    digits = re.sub(r'\D', '', str(phone))

    # 11æ¡ã®å ´åˆï¼ˆæºå¸¯é›»è©±ãªã©ï¼‰
    # ä¾‹: 09012345678 â†’ 090-1234-5678
    if len(digits) == 11:
        return f"{digits[:3]}-{digits[3:7]}-{digits[7:]}"

    # 10æ¡ã®å ´åˆï¼ˆå›ºå®šé›»è©±ãªã©ï¼‰
    # ä¾‹: 0312345678 â†’ 03-1234-5678
    elif len(digits) == 10:
        return f"{digits[:2]}-{digits[2:6]}-{digits[6:]}"

    # ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾è¿”ã™
    return digits


def format_postal(postal):
    """
    éƒµä¾¿ç•ªå·ã‚’æ•´å½¢ã™ã‚‹ï¼ˆ123-4567å½¢å¼ï¼‰

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    1234567 â†’ 123-4567 ã®ã‚ˆã†ã«ã€
    ãƒã‚¤ãƒ•ãƒ³ã‚’å…¥ã‚Œã¦è¦‹ã‚„ã™ãã—ã¾ã™ã€‚

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. æ•°å­—ä»¥å¤–ã®æ–‡å­—ã‚’å‰Šé™¤ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã©ï¼‰
    2. æ¡æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    3. 7æ¡ãªã‚‰ 123-4567 å½¢å¼

    å¼•æ•°:
        postal (str): éƒµä¾¿ç•ªå·

    æˆ»ã‚Šå€¤:
        str: æ•´å½¢ã•ã‚ŒãŸéƒµä¾¿ç•ªå·

    ä½¿ç”¨ä¾‹:
        >>> format_postal("1234567")
        "123-4567"
        >>> format_postal("123-4567")
        "123-4567"
    """
    # ç©ºæ¬„ã®å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    if pd.isna(postal) or postal == '':
        return ''

    # æ•°å­—ä»¥å¤–ã‚’å‰Šé™¤
    digits = re.sub(r'\D', '', str(postal))

    # 7æ¡ã®å ´åˆ
    if len(digits) == 7:
        return f"{digits[:3]}-{digits[3:]}"

    # ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾è¿”ã™
    return digits


# =========================================================================
# ã€4ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå‡¦ç†é–¢æ•°
# =========================================================================

def extract_survey_emails(excel_path, email_column_index=1):
    """
    Excelã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡ºã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    å’æ¥­å¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆExcelï¼‰ã‹ã‚‰ã€
    å›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã¯å„ªå…ˆé †ä½ãŒé«˜ã„ã®ã§ã€
    å›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç‰¹å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åˆ—ï¼ˆé€šå¸¸ã¯2åˆ—ç›®ï¼‰ã‚’å–å¾—
    3. @ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã¿æŠ½å‡ºï¼ˆæœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
    4. å°æ–‡å­—ã«çµ±ä¸€ã—ã¦é‡è¤‡ã‚’å‰Šé™¤
    5. ã‚»ãƒƒãƒˆã«ã—ã¦è¿”ã™

    å¼•æ•°:
        excel_path (Path): Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        email_column_index (int): ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åˆ—ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1 = 2åˆ—ç›®ï¼‰

    æˆ»ã‚Šå€¤:
        set: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚»ãƒƒãƒˆ

    ä½¿ç”¨ä¾‹:
        >>> extract_survey_emails(Path("HCU7æœŸå’æ¥­å¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ.xlsx"))
        {"user1@example.com", "user2@example.com", ...}
    """
    try:
        # Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        df = pd.read_excel(excel_path)

        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åˆ—ã‚’å–å¾—
        # é€šå¸¸ã€Googleãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã¯ã€
        # 1åˆ—ç›®ãŒã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€2åˆ—ç›®ãŒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        email_col = df.columns[email_column_index]

        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
        emails = df[email_col].dropna().astype(str).str.lower().str.strip()

        # @ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã¿ï¼ˆæœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
        valid_emails = emails[emails.str.contains('@', na=False)]

        # ã‚»ãƒƒãƒˆã«ã—ã¦è¿”ã™ï¼ˆé‡è¤‡ã‚’è‡ªå‹•çš„ã«å‰Šé™¤ï¼‰
        return set(valid_emails)

    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€è­¦å‘Šã‚’è¡¨ç¤ºã—ã¦ç©ºã®ã‚»ãƒƒãƒˆã‚’è¿”ã™
        print(f"  âš ï¸ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {excel_path.name} - {e}")
        return set()


def extract_survey_data(excel_path, email_column_index=1, name_column_index=2):
    """
    Excelã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡ºã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    å’æ¥­å¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆExcelï¼‰ã‹ã‚‰ã€
    å›ç­”è€…ã®æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸¡æ–¹ã§ãƒãƒƒãƒãƒ³ã‚°ã‚’è©¦ã¿ã‚‹ãŸã‚ã€
    ä¸¡æ–¹ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    2. æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åˆ—ã‚’å–å¾—
    3. æ­£è¦åŒ–ã—ã¦è¿”ã™ï¼ˆæ°åã¯æ­£è¦åŒ–ã€ãƒ¡ãƒ¼ãƒ«ã¯å°æ–‡å­—åŒ–ï¼‰

    å¼•æ•°:
        excel_path (Path): Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        email_column_index (int): ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åˆ—ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1 = 2åˆ—ç›®ï¼‰
        name_column_index (int): æ°åã®åˆ—ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2 = 3åˆ—ç›®ï¼‰

    æˆ»ã‚Šå€¤:
        dict: {'names': set(æ°åã‚»ãƒƒãƒˆ), 'emails': set(ãƒ¡ãƒ¼ãƒ«ã‚»ãƒƒãƒˆ)}

    ä½¿ç”¨ä¾‹:
        >>> extract_survey_data(Path("HCU7æœŸå’æ¥­å¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ.xlsx"))
        {'names': {'æœ€ä¸Šè¼æœªå­', ...}, 'emails': {'user@example.com', ...}}
    """
    try:
        # Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        df = pd.read_excel(excel_path)

        result = {'names': set(), 'emails': set()}

        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
        if email_column_index < len(df.columns):
            email_col = df.columns[email_column_index]
            emails = df[email_col].dropna().astype(str).str.lower().str.strip()
            valid_emails = emails[emails.str.contains('@', na=False)]
            result['emails'] = set(valid_emails)

        # æ°åã‚’æŠ½å‡ºï¼ˆæ°ååˆ—ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if name_column_index < len(df.columns):
            name_col = df.columns[name_column_index]
            names = df[name_col].dropna().astype(str)
            # æ°åã‚’æ­£è¦åŒ–
            normalized_names = names.apply(normalize_name)
            # ç©ºæ¬„ã‚’é™¤å¤–
            valid_names = normalized_names[normalized_names != '']
            result['names'] = set(valid_names)

        return result

    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€è­¦å‘Šã‚’è¡¨ç¤ºã—ã¦ç©ºã®è¾æ›¸ã‚’è¿”ã™
        print(f"  âš ï¸ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {excel_path.name} - {e}")
        return {'names': set(), 'emails': set()}


# =========================================================================
# ã€5ã€‘ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é–¢æ•°
# =========================================================================

def check_address_duplicates(df, address_column='ä½æ‰€', top_n=10):
    """
    ä½æ‰€ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    åŒã˜ä½æ‰€ãŒè¤‡æ•°å›å‡ºç¾ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    ãƒ‡ãƒ¼ã‚¿å“è³ªã‚’ç¢ºèªã™ã‚‹ãŸã‚ã§ã™ã€‚
    åŒã˜ä½æ‰€ã«è¤‡æ•°äººãŒä½ã‚“ã§ã„ã‚‹å ´åˆã€
    å®¶æ—ã‚„åŒã˜ä¼šç¤¾ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. ä½æ‰€ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
    2. 2ä»¶ä»¥ä¸Šã®é‡è¤‡ã®ã¿æŠ½å‡º
    3. ä¸Šä½Nä»¶ã‚’å–å¾—

    å¼•æ•°:
        df (pandas.DataFrame): ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
        address_column (str): ä½æ‰€ã®åˆ—å
        top_n (int): ä¸Šä½ä½•ä»¶ã‚’è¡¨ç¤ºã™ã‚‹ã‹

    æˆ»ã‚Šå€¤:
        tuple: (é‡è¤‡ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ , é‡è¤‡ä»¶æ•°)

    ä½¿ç”¨ä¾‹:
        >>> df_duplicates, duplicate_count = check_address_duplicates(df, top_n=10)
        >>> print(f"é‡è¤‡ä½æ‰€: {duplicate_count} ä»¶")
    """
    # ä½æ‰€ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
    address_counts = df[address_column].value_counts()

    # 2ä»¶ä»¥ä¸Šã®é‡è¤‡ã®ã¿æŠ½å‡º
    duplicates = address_counts[address_counts > 1]

    # ä¸Šä½Nä»¶ã‚’å–å¾—
    top_duplicates = duplicates.head(top_n)

    # DataFrameã«å¤‰æ›
    df_duplicates = pd.DataFrame({
        'é †ä½': [f"{i+1}." for i in range(len(top_duplicates))],
        'ä½æ‰€': top_duplicates.index.tolist(),
        'ä»¶æ•°': top_duplicates.values.tolist()
    })

    return df_duplicates, len(duplicates)


def calculate_data_quality(df):
    """
    ãƒ‡ãƒ¼ã‚¿å“è³ªã‚’è¨ˆç®—ã™ã‚‹ï¼ˆæ¬ æç‡ãªã©ï¼‰

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    é›»è©±ç•ªå·ã€ä½æ‰€ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©ã®
    ãƒ‡ãƒ¼ã‚¿ä¿æœ‰ç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

    ã€ãªãœå¿…è¦ã‹ã€‘
    ãƒ‡ãƒ¼ã‚¿ã®å“è³ªã‚’ç¢ºèªã—ã€å•é¡ŒãŒã‚ã‚Œã°å¯¾å‡¦ã—ã¾ã™ã€‚

    ä¾‹ãˆã°ã€é›»è©±ç•ªå·ãŒ50%ã—ã‹ãªã„å ´åˆã€
    ãƒ‡ãƒ¼ã‚¿ã®åé›†æ–¹æ³•ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. å„é …ç›®ã®ä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆnullä»¥å¤–ï¼‰
    2. å…¨ä½“ä»¶æ•°ã§å‰²ã£ã¦å‰²åˆã‚’è¨ˆç®—
    3. DataFrameã«ã¾ã¨ã‚ã¦è¿”ã™

    å¼•æ•°:
        df (pandas.DataFrame): ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 

    æˆ»ã‚Šå€¤:
        pandas.DataFrame: ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯çµæœ

    ä½¿ç”¨ä¾‹:
        >>> quality_df = calculate_data_quality(df)
        >>> print(quality_df)
        ãƒã‚§ãƒƒã‚¯é …ç›®            ä»¶æ•°  å…¨ä½“  å‰²åˆ(%)
        é›»è©±ç•ªå·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°      1500  2000   75.0
        ä½æ‰€ãƒ‡ãƒ¼ã‚¿ä»¶æ•°         1800  2000   90.0
        ...
    """
    total = len(df)  # å…¨ä½“ã®ä»¶æ•°

    # å„é …ç›®ã®ä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆnullä»¥å¤–ï¼‰
    phone_count = df['é›»è©±ç•ªå·'].notna().sum()
    address_count = df['ä½æ‰€'].notna().sum()
    prefecture_count = df['éƒ½é“åºœçœŒ'].notna().sum()
    email_count = df['Eãƒ¡ãƒ¼ãƒ«'].notna().sum()

    # DataFrameã«å¤‰æ›
    quality_data = {
        'ãƒã‚§ãƒƒã‚¯é …ç›®': [
            'é›»è©±ç•ªå·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°',
            'ä½æ‰€ãƒ‡ãƒ¼ã‚¿ä»¶æ•°',
            'éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ä»¶æ•°',
            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‡ãƒ¼ã‚¿ä»¶æ•°'
        ],
        'ä»¶æ•°': [phone_count, address_count, prefecture_count, email_count],
        'å…¨ä½“': [total, total, total, total],
        'å‰²åˆ(%)': [
            f"{phone_count / total * 100:.1f}",
            f"{address_count / total * 100:.1f}",
            f"{prefecture_count / total * 100:.1f}",
            f"{email_count / total * 100:.1f}"
        ]
    }

    return pd.DataFrame(quality_data)


# =========================================================================
# ã€6ã€‘å„ªå…ˆé †ä½è¨ˆç®—é–¢æ•°
# =========================================================================

def calculate_priority(row, survey_emails):
    """
    é¡§å®¢ã®å„ªå…ˆé †ä½ã‚’è¨ˆç®—ã™ã‚‹

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    æœŸç•ªå·ã¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”çŠ¶æ³ã‹ã‚‰ã€
    å–¶æ¥­å„ªå…ˆé †ä½ï¼ˆ1ï½4ï¼‰ã‚’æ±ºå®šã—ã¾ã™ã€‚

    ã€å„ªå…ˆé †ä½ã®å®šç¾©ã€‘
    1: 12æœŸç”Ÿï¼ˆæœ€å„ªå…ˆï¼‰
    2: 7ï½11æœŸ + ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ï¼ˆæ¬¡ã«å„ªå…ˆï¼‰
    3: 7ï½11æœŸ + æœªå›ç­”ï¼ˆãã®æ¬¡ï¼‰
    4: 1ï½6æœŸï¼ˆä½å„ªå…ˆï¼‰

    ã€ãªãœã“ã®é †ç•ªãªã®ã‹ã€‘
    - 12æœŸç”Ÿã¯æœ€æ–°ã®å—è¬›ç”Ÿãªã®ã§ã€æœ€ã‚‚å„ªå…ˆåº¦ãŒé«˜ã„
    - 7ï½11æœŸã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã¯ã€é–¢ä¿‚æ€§ãŒå¼·ã„ã¨åˆ¤æ–­
    - 7ï½11æœŸã§ã‚‚æœªå›ç­”è€…ã¯ã€å„ªå…ˆåº¦ã‚’ä¸‹ã’ã‚‹
    - 1ï½6æœŸã¯å—è¬›ã‹ã‚‰æ™‚é–“ãŒçµŒã£ã¦ã„ã‚‹ãŸã‚ã€å„ªå…ˆåº¦ã¯ä½ã„

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. æœŸç•ªå·ã‚’å–å¾—
    2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    3. æ¡ä»¶ã«å¿œã˜ã¦å„ªå…ˆé †ä½ã‚’è¿”ã™

    å¼•æ•°:
        row (pandas.Series): 1è¡Œåˆ†ã®ãƒ‡ãƒ¼ã‚¿
        survey_emails (set): ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚»ãƒƒãƒˆ

    æˆ»ã‚Šå€¤:
        int: å„ªå…ˆé †ä½ï¼ˆ1ï½4ï¼‰

    ä½¿ç”¨ä¾‹:
        >>> row = {'æœŸ_ç•ªå·': 12, 'Eãƒ¡ãƒ¼ãƒ«': 'user@example.com'}
        >>> calculate_priority(row, survey_emails)
        1  # 12æœŸç”Ÿãªã®ã§å„ªå…ˆé †ä½1
    """
    period_num = row['æœŸ_ç•ªå·']  # æœŸç•ªå·ï¼ˆ1ï½12ï¼‰
    email = row['Eãƒ¡ãƒ¼ãƒ«']  # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

    # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒã‚§ãƒƒã‚¯
    is_survey_respondent = email in survey_emails

    # å„ªå…ˆé †ä½ã‚’åˆ¤å®š
    if period_num == 12:
        # å„ªå…ˆé †ä½1: 12æœŸç”Ÿ
        return 1
    elif 7 <= period_num <= 11 and is_survey_respondent:
        # å„ªå…ˆé †ä½2: 7ï½11æœŸ + ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”
        return 2
    elif 7 <= period_num <= 11:
        # å„ªå…ˆé †ä½3: 7ï½11æœŸ + æœªå›ç­”
        return 3
    else:
        # å„ªå…ˆé †ä½4: 1ï½6æœŸ
        return 4


# =========================================================================
# ã€7ã€‘éƒµä¾¿ç•ªå·ã‹ã‚‰éƒ½é“åºœçœŒã‚’è£œå®Œã™ã‚‹é–¢æ•°
# =========================================================================

def get_prefecture_from_postal_code(postal_code_str, postal_mapping):
    """
    éƒµä¾¿ç•ªå·æ–‡å­—åˆ—ã‹ã‚‰éƒ½é“åºœçœŒã‚’æŠ½å‡º

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    éƒµä¾¿ç•ªå·ã®æœ€åˆã®3æ¡ã‹ã‚‰éƒ½é“åºœçœŒã‚’åˆ¤å®šã—ã¾ã™ã€‚

    ã€ä½¿ç”¨ä¾‹ã€‘
    get_prefecture_from_postal_code('1001111', POSTAL_CODE_TO_PREFECTURE) â†’ 'æ±äº¬éƒ½'
    get_prefecture_from_postal_code('100-1111', POSTAL_CODE_TO_PREFECTURE) â†’ 'æ±äº¬éƒ½'
    get_prefecture_from_postal_code('9601111', POSTAL_CODE_TO_PREFECTURE) â†’ 'ç¦å³¶çœŒ'

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. éƒµä¾¿ç•ªå·ã‹ã‚‰æ•°å­—ã®ã¿ã‚’æŠ½å‡º
    2. æœ€åˆã®3æ¡ã‚’å–å¾—
    3. ãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸ã§æ¤œç´¢
    4. ãƒãƒƒãƒã—ãŸéƒ½é“åºœçœŒã‚’è¿”ã™

    å¼•æ•°:
        postal_code_str (str): éƒµä¾¿ç•ªå·æ–‡å­—åˆ—ï¼ˆãƒã‚¤ãƒ•ãƒ³ã‚ã‚Šãƒ»ãªã—ä¸¡å¯¾å¿œï¼‰
        postal_mapping (dict): éƒµä¾¿ç•ªå·â†’éƒ½é“åºœçœŒã®ãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸

    æˆ»ã‚Šå€¤:
        str or None: éƒ½é“åºœçœŒåï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯Noneï¼‰
    """
    # ç©ºæ¬„ã®å ´åˆã¯Noneã‚’è¿”ã™
    if pd.isna(postal_code_str) or postal_code_str == '':
        return None

    # éƒµä¾¿ç•ªå·ã‹ã‚‰æ•°å­—ã®ã¿ã‚’æŠ½å‡º
    postal_digits = re.sub(r'\D', '', str(postal_code_str))

    if len(postal_digits) < 3:
        return None

    # æœ€åˆã®3æ¡ã§æ¤œç´¢
    prefix_3digit = postal_digits[:3]

    # ãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸ã§æ¤œç´¢
    return postal_mapping.get(prefix_3digit, None)


def fill_prefecture_from_postal_code(df, postal_code_col='éƒµä¾¿ç•ªå·_ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', prefecture_col='éƒ½é“åºœçœŒ'):
    """
    ã€æ–°è¦æ©Ÿèƒ½ã€‘éƒµä¾¿ç•ªå·ã‚’ã‚‚ã¨ã«éƒ½é“åºœçœŒã‚’è£œå®Œ

    ã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€‘
    éƒµä¾¿ç•ªå·ãŒå­˜åœ¨ã™ã‚‹ãŒã€éƒ½é“åºœçœŒãŒç©ºæ¬„ã®ã‚»ãƒ«ã«å¯¾ã—ã¦ã€
    éƒµä¾¿ç•ªå·ã®æœ€åˆã®3æ¡ã‚’ã‚‚ã¨ã«ã€å¯¾å¿œã™ã‚‹éƒ½é“åºœçœŒã‚’è‡ªå‹•è£œå®Œã—ã¾ã™ã€‚

    ä¾‹:
    - éƒµä¾¿ç•ªå·: 1001234 â†’ éƒ½é“åºœçœŒã‚’ã€Œæ±äº¬éƒ½ã€ã«è£œå®Œ
    - éƒµä¾¿ç•ªå·: 5301234 â†’ éƒ½é“åºœçœŒã‚’ã€Œå¤§é˜ªåºœã€ã«è£œå®Œ
    - éƒµä¾¿ç•ªå·: 9601234 â†’ éƒ½é“åºœçœŒã‚’ã€Œç¦å³¶çœŒã€ã«è£œå®Œ

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    1. éƒµä¾¿ç•ªå·â†’éƒ½é“åºœçœŒãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸ã‚’å–å¾—ï¼ˆ02_config.py ã‹ã‚‰ï¼‰
    2. df ã‚’èµ°æŸ»:
       - éƒµä¾¿ç•ªå·ãŒå­˜åœ¨ã—ã€éƒ½é“åºœçœŒãŒç©ºæ¬„ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
       - éƒµä¾¿ç•ªå·ã®æœ€åˆã®3æ¡ã‹ã‚‰å¯¾å¿œã™ã‚‹éƒ½é“åºœçœŒã‚’æ¤œç´¢
       - ãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚’éƒ½é“åºœçœŒã‚«ãƒ©ãƒ ã«è¨˜å…¥
    3. è£œå®Œçµæœã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼†ãƒ­ã‚°å‡ºåŠ›

    å¼•æ•°:
        df (DataFrame): é¡§å®¢ãƒ‡ãƒ¼ã‚¿
        postal_code_col (str): éƒµä¾¿ç•ªå·ã‚«ãƒ©ãƒ å
        prefecture_col (str): éƒ½é“åºœçœŒã‚«ãƒ©ãƒ å

    æˆ»ã‚Šå€¤:
        tuple: (è£œå®Œæ¸ˆã¿DF, è£œå®Œä»¶æ•°, è£œå®Œã§ããªã‹ã£ãŸä»¶æ•°)
    """
    # 02_config.py ã‹ã‚‰éƒµä¾¿ç•ªå·ãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    # ï¼ˆã“ã®é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹æ™‚ç‚¹ã§ã€ã™ã§ã« config_02 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ POSTAL_CODE_TO_PREFECTURE ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å‰æï¼‰
    from config_02 import POSTAL_CODE_TO_PREFECTURE

    # è£œå®Œå‰ã®éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’è¨˜éŒ²
    before_count = df[prefecture_col].notna().sum()

    # éƒµä¾¿ç•ªå·ãŒå­˜åœ¨ã—ã€éƒ½é“åºœçœŒãŒç©ºæ¬„ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
    mask_needs_completion = df[postal_code_col].notna() & df[prefecture_col].isna()
    needs_completion_count = mask_needs_completion.sum()

    print(f"  ğŸ“ éƒµä¾¿ç•ªå·ãŒå­˜åœ¨ã—ã€éƒ½é“åºœçœŒãŒç©ºæ¬„: {needs_completion_count:,} ä»¶")

    # è£œå®Œã‚’å®Ÿè¡Œ
    completed_count = 0
    failed_count = 0

    for idx in df[mask_needs_completion].index:
        postal_code = df.at[idx, postal_code_col]
        prefecture = get_prefecture_from_postal_code(postal_code, POSTAL_CODE_TO_PREFECTURE)

        if prefecture:
            df.at[idx, prefecture_col] = prefecture
            completed_count += 1
        else:
            failed_count += 1

    # è£œå®Œå¾Œã®éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ä»¶æ•°
    after_count = df[prefecture_col].notna().sum()

    return df, completed_count, failed_count


# =========================================================================
# ã€8ã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç´ã¥ã‘é–¢æ•°ï¼ˆæ°åï¼‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
# =========================================================================

def merge_survey_data_enhanced(df_combined, survey_data_dict):
    """
    ã€æ”¹å–„ç‰ˆã€‘ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã‚’ãƒ‡ãƒ¼ã‚¿ã«ç´ã¥ã‘ã‚‹

    ã€æ”¹å–„å†…å®¹ã€‘
    1. æ°åã§ã®ç´ã¥ã‘ã‚’å®Ÿè¡Œ
    2. æ°åã§ã®ç´ã¥ã‘ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚è©¦è¡Œ
    3. ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’ãƒ­ã‚°ã«å‡ºåŠ›

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    1. df_combined ã« 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”' ã‚«ãƒ©ãƒ ã‚’åˆæœŸåŒ–ï¼ˆFalseï¼‰
    2. å„èª¿æŸ»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆHCU7ï½11ï¼‰ã‹ã‚‰æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚’æŠ½å‡º
    3. df_combined ã‚’èµ°æŸ»ã—ã¦:
       - ç¬¬1æ®µéš: æ°åã§å®Œå…¨ä¸€è‡´ã‚’ç¢ºèª
       - ç¬¬2æ®µéš: æ°åæœªãƒãƒƒãƒãªã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã§å®Œå…¨ä¸€è‡´ã‚’ç¢ºèª
       - ãƒãƒƒãƒçµæœã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    4. ãƒ­ã‚°ã«ä»¥ä¸‹ã‚’å‡ºåŠ›:
       âœ… HCU8æœŸ: 13ä»¶ï¼ˆæ°å: 13ä»¶, ãƒ¡ãƒ¼ãƒ«: 0ä»¶ï¼‰
       âœ… HCU9æœŸ: 53ä»¶ï¼ˆæ°å: 50ä»¶, ãƒ¡ãƒ¼ãƒ«: 3ä»¶ï¼‰
       ...
       ğŸ“Š ç·ãƒãƒƒãƒæ•°: 91ä»¶ â†’ â—‹â—‹ä»¶ï¼ˆãƒ¡ãƒ¼ãƒ«ã§è¿½åŠ ãƒãƒƒãƒï¼‰

    å¼•æ•°:
        df_combined (DataFrame): å…¨æœŸé–“ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆæ°åãŒæ­£è¦åŒ–æ¸ˆã¿ï¼‰
        survey_data_dict (dict): {æœŸç•ªå·: ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹}

    æˆ»ã‚Šå€¤:
        tuple: (ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°ãŒè¿½åŠ ã•ã‚ŒãŸDF, ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚»ãƒƒãƒˆ)
    """
    # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°ã‚’åˆæœŸåŒ–
    df_combined['ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'] = False

    # å…¨æœŸã®é›†è¨ˆç”¨
    total_name_matches = 0
    total_email_matches = 0
    all_survey_emails = set()

    print("\nå„æœŸã®ãƒãƒƒãƒãƒ³ã‚°çµæœ:")

    # å„æœŸã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
    for period, filepath in survey_data_dict.items():
        try:
            # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
            survey_data = extract_survey_data(filepath)
            survey_names = survey_data['names']
            survey_emails = survey_data['emails']

            # ã“ã®æœŸã®ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            name_match_count = 0
            email_match_count = 0

            # æ°åã§ãƒãƒƒãƒãƒ³ã‚°
            for name in survey_names:
                # æ°åãŒå®Œå…¨ä¸€è‡´ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™
                mask = (df_combined['æ°å_key'] == name) & (~df_combined['ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'])
                matched_indices = df_combined[mask].index

                if len(matched_indices) > 0:
                    # ãƒãƒƒãƒã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    df_combined.loc[matched_indices, 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'] = True
                    name_match_count += len(matched_indices)

            # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒãƒƒãƒãƒ³ã‚°ï¼ˆæ°åã§ãƒãƒƒãƒã—ãªã‹ã£ãŸã‚‚ã®ã®ã¿ï¼‰
            for email in survey_emails:
                # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå®Œå…¨ä¸€è‡´ã—ã€ã¾ã ãƒãƒƒãƒã—ã¦ã„ãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™
                mask = (df_combined['Eãƒ¡ãƒ¼ãƒ«'] == email) & (~df_combined['ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'])
                matched_indices = df_combined[mask].index

                if len(matched_indices) > 0:
                    # ãƒãƒƒãƒã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    df_combined.loc[matched_indices, 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'] = True
                    email_match_count += len(matched_indices)

            # å…¨æœŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚»ãƒƒãƒˆã«è¿½åŠ ï¼ˆå„ªå…ˆé †ä½è¨ˆç®—ç”¨ï¼‰
            all_survey_emails.update(survey_emails)

            # ã“ã®æœŸã®çµæœã‚’ãƒ­ã‚°å‡ºåŠ›
            total_matches = name_match_count + email_match_count
            if email_match_count > 0:
                print(f"  âœ… HCU{period}æœŸ: {total_matches} ä»¶ï¼ˆæ°å: {name_match_count}ä»¶, ãƒ¡ãƒ¼ãƒ«: {email_match_count}ä»¶â˜…ï¼‰")
            else:
                print(f"  âœ… HCU{period}æœŸ: {total_matches} ä»¶ï¼ˆæ°å: {name_match_count}ä»¶, ãƒ¡ãƒ¼ãƒ«: {email_match_count}ä»¶ï¼‰")

            # å…¨æœŸã®é›†è¨ˆã«åŠ ç®—
            total_name_matches += name_match_count
            total_email_matches += email_match_count

        except FileNotFoundError:
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
            print(f"  âš ï¸ HCU{period}æœŸ: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        except Exception as e:
            # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
            print(f"  âš ï¸ HCU{period}æœŸ: ã‚¨ãƒ©ãƒ¼ - {e}")

    # ç·ãƒãƒƒãƒæ•°ã‚’è¨ˆç®—
    total_respondents = df_combined['ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”'].sum()
    total_customers = len(df_combined)
    response_rate = total_respondents / total_customers * 100

    print(f"\n  ğŸ“Š ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…æ•°: {total_respondents:,} äºº / {total_customers:,} äºº ({response_rate:.1f}%)")
    print(f"     å†…è¨³: æ°åãƒãƒƒãƒ {total_name_matches}ä»¶ã€ãƒ¡ãƒ¼ãƒ«ãƒãƒƒãƒ {total_email_matches}ä»¶ï¼ˆæ–°è¦ï¼‰")

    return df_combined, all_survey_emails


def generate_survey_response_details(df_combined, survey_data_dict):
    """
    ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹

    ã€ç›®çš„ã€‘
    ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã®è©³ç´°æƒ…å ±ã‚’ä¸€è¦§åŒ–ã—ã€
    ãƒãƒƒãƒãƒ³ã‚°æ–¹æ³•ï¼ˆæ°å/ãƒ¡ãƒ¼ãƒ«/æœªãƒãƒƒãƒï¼‰ã‚’æ˜ç¤ºã™ã‚‹

    ã€å‡ºåŠ›ã‚«ãƒ©ãƒ ã€‘
    - æ°åï¼ˆé¡§å®¢ï¼‰
    - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé¡§å®¢ï¼‰
    - æ°åï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰
    - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰
    - ãƒãƒƒãƒãƒ³ã‚°æ–¹æ³•
    - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”æœŸ
    - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°

    å¼•æ•°:
        df_combined (DataFrame): å…¨æœŸé–“ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒãƒãƒ³ã‚°æ¸ˆã¿ï¼‰
        survey_data_dict (dict): {æœŸç•ªå·: ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹}

    æˆ»ã‚Šå€¤:
        DataFrame: ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è©³ç´°ãƒ‡ãƒ¼ã‚¿
    """
    detail_records = []

    # å„æœŸã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
    for period, filepath in survey_data_dict.items():
        try:
            # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ°åã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
            survey_data = extract_survey_data(filepath)
            survey_names = survey_data['names']
            survey_emails = survey_data['emails']

            # ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”è€…ã”ã¨ã«å‡¦ç†
            # 1. æ°åã§ãƒãƒƒãƒãƒ³ã‚°ç¢ºèª
            for survey_name in survey_names:
                mask = df_combined['æ°å_key'] == survey_name
                matched_customers = df_combined[mask]

                if len(matched_customers) > 0:
                    for _, customer in matched_customers.iterrows():
                        detail_records.append({
                            'æ°åï¼ˆé¡§å®¢ï¼‰': customer.get('æ°å', ''),
                            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé¡§å®¢ï¼‰': customer.get('Eãƒ¡ãƒ¼ãƒ«', ''),
                            'æ°åï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰': survey_name,
                            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰': '',  # æ°åãƒãƒƒãƒæ™‚ã¯ãƒ¡ãƒ¼ãƒ«ä¸æ˜
                            'ãƒãƒƒãƒãƒ³ã‚°æ–¹æ³•': 'æ°å',
                            'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”æœŸ': f'HCU{period}',
                            'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°': 'â—‹'
                        })

            # 2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒãƒƒãƒãƒ³ã‚°ç¢ºèªï¼ˆæ°åã§ãƒãƒƒãƒã—ãªã‹ã£ãŸã‚‚ã®ã®ã¿ï¼‰
            for survey_email in survey_emails:
                mask = (df_combined['Eãƒ¡ãƒ¼ãƒ«'] == survey_email) & \
                       (~df_combined['æ°å_key'].isin(survey_names))
                matched_customers = df_combined[mask]

                if len(matched_customers) > 0:
                    for _, customer in matched_customers.iterrows():
                        detail_records.append({
                            'æ°åï¼ˆé¡§å®¢ï¼‰': customer.get('æ°å', ''),
                            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé¡§å®¢ï¼‰': customer.get('Eãƒ¡ãƒ¼ãƒ«', ''),
                            'æ°åï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰': '',  # ãƒ¡ãƒ¼ãƒ«ãƒãƒƒãƒæ™‚ã¯æ°åä¸æ˜
                            'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰': survey_email,
                            'ãƒãƒƒãƒãƒ³ã‚°æ–¹æ³•': 'ãƒ¡ãƒ¼ãƒ«',
                            'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”æœŸ': f'HCU{period}',
                            'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ•ãƒ©ã‚°': 'â—‹'
                        })

        except Exception as e:
            print(f"  âš ï¸ HCU{period}æœŸã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")

    # DataFrameã«å¤‰æ›
    df_details = pd.DataFrame(detail_records)

    # é‡è¤‡ã‚’å‰Šé™¤ï¼ˆåŒã˜é¡§å®¢ãŒè¤‡æ•°æœŸã«å›ç­”ã—ã¦ã„ã‚‹å ´åˆï¼‰
    if len(df_details) > 0:
        df_details = df_details.drop_duplicates(subset=['æ°åï¼ˆé¡§å®¢ï¼‰', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé¡§å®¢ï¼‰'], keep='first')

    return df_details
